<!DOCTYPE html>
<html>
<head>
    <title>POLYU-Peng's Lab: Pitch Sensitivity Training</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f8f8;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            width: 100%;
        }
        .training-info {
            font-size: 16px;
            color: #555;
            margin-top: 10px;
            margin-bottom: 5px;
            text-align: center;
        }
        .instruction-text {
            font-size: 14px;
            color: #777;
            margin-bottom: 15px;
            text-align: center;
            font-style: italic;
        }
        .button-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            width: 100%;
        }
        .prompt-text {
            text-align: center;
            font-size: 20px;
            margin-bottom: 25px;
            margin-top: 30px;
            font-weight: bold;
        }
        .response-button {
            width: 160px;
            height: 160px;
            font-size: 26px;
            margin: 0 40px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .response-button:hover:enabled {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .response-button:active:enabled {
            transform: translateY(1px);
        }
        .button-playing {
            animation: pulse 1s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(102, 204, 255, 0.8);
            transform: scale(1.05);
        }
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(102, 204, 255, 0.8);
            }
            50% {
                box-shadow: 0 0 30px rgba(102, 204, 255, 1);
            }
        }
        .control-button-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            width: 100%;
        }
        .control-button {
            padding: 14px 28px;
            font-size: 18px;
            border-radius: 8px;
            border: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .control-button:hover:enabled {
            background-color: #3e8e41;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .control-button:active:enabled {
            transform: translateY(1px);
        }
        .control-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .feedback {
            text-align: center;
            height: 100px;
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .status {
            width: 350px;
            height: 68px;
            text-align: center;
            font-size: 18px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .debug-info {
            font-size: 12px;
            color: #777;
            margin-top: 30px;
            text-align: left;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
        }
        .results-container {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f8ff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
        }
        .result-heading {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .result-table th, .result-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .result-table th {
            background-color: #3498db;
            color: white;
        }
        .result-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .result-interpretation {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .back-button {
            display: block;
            margin: 0 auto;
            padding: 14px 28px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .back-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .back-button:active {
            transform: translateY(1px);
        }
        .chart-container {
            height: 300px;
            margin: 20px 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .auxiliary-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }
        .auxiliary-buttons button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .auxiliary-buttons button:hover {
            background-color: #e0e0e0;
        }
        .diagnostic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .diagnostic-content {
            width: 80%;
            max-width: 700px;
            max-height: 80%;
            overflow-y: auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .diagnostic-heading {
            text-align: center;
            color: #e74c3c;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .diagnostic-close {
            float: right;
            font-size: 20px;
            cursor: pointer;
            color: #777;
        }
        .diagnostic-close:hover {
            color: #333;
        }
        .diagnostic-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .diagnostic-actions {
            text-align: center;
            margin-top: 20px;
        }
        .diagnostic-action-button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .retry-button {
            background-color: #3498db;
            color: white;
        }
        .retry-button:hover {
            background-color: #2980b9;
        }
        .continue-button {
            background-color: #2ecc71;
            color: white;
        }
        .continue-button:hover {
            background-color: #27ae60;
        }
        .diagnostic-file-status {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .file-status-item {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 3px;
            background-color: #f8f8f8;
        }
        .file-found {
            color: #27ae60;
            border-left: 3px solid #27ae60;
        }
        .file-missing {
            color: #e74c3c;
            border-left: 3px solid #e74c3c;
        }
        .statistics-table {
            width: 100%;
            margin: 10px 0;
            border-collapse: collapse;
        }
        .statistics-table th, .statistics-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .statistics-table th {
            background-color: #f0f0f0;
        }
        .direction-stats-good {
            color: #27ae60;
        }
        .direction-stats-warning {
            color: #f39c12;
        }
        .direction-stats-bad {
            color: #e74c3c;
        }
        /* 平板适配 */
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            .container {
                padding: 15px;
            }
            .header img {
                max-width: 100%;
                height: auto;
            }
            .response-button {
                width: 140px;
                height: 140px;
                font-size: 24px;
                margin: 0 25px;
            }
            .status {
                width: 90%;
                max-width: 350px;
            }
            .result-table {
                font-size: 14px;
            }
            .result-table th, .result-table td {
                padding: 8px 6px;
            }
        }
        
        /* 手机适配 */
        @media (max-width: 600px) {
            body {
                margin: 5px;
            }
            .container {
                padding: 10px;
                border-radius: 8px;
            }
            .header {
                margin-bottom: 20px;
            }
            .header img {
                max-width: 100%;
                height: auto;
            }
            .training-info {
                font-size: 14px;
            }
            .instruction-text {
                font-size: 12px;
            }
            .prompt-text {
                font-size: 18px;
                margin-top: 20px;
                margin-bottom: 15px;
            }
            .response-button {
                width: 110px;
                height: 110px;
                font-size: 18px;
                margin: 0 10px;
            }
            .control-button-container {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            .control-button {
                padding: 12px 24px;
                font-size: 16px;
                width: 80%;
                max-width: 200px;
            }
            .feedback {
                height: 80px;
                margin: 20px 0;
            }
            .feedback img {
                width: 80px;
                height: auto;
            }
            .status {
                width: 95%;
                max-width: 100%;
                height: auto;
                min-height: 50px;
                font-size: 16px;
                padding: 8px;
            }
            .auxiliary-buttons {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            .auxiliary-buttons button {
                width: 100%;
                padding: 12px 15px;
                font-size: 14px;
            }
            .auxiliary-buttons label {
                width: 100%;
                text-align: center;
            }
            .results-container {
                padding: 15px;
            }
            .result-heading {
                font-size: 18px;
            }
            .result-table {
                font-size: 12px;
            }
            .result-table th, .result-table td {
                padding: 6px 4px;
            }
            .highlight-box {
                padding: 10px;
            }
            .highlight-value {
                font-size: 22px;
            }
            .back-button, .print-button {
                width: 80%;
                max-width: 200px;
                padding: 12px 20px;
                font-size: 16px;
            }
            .diagnostic-content {
                width: 95%;
                max-height: 90%;
                padding: 15px;
            }
            .diagnostic-heading {
                font-size: 20px;
            }
            .statistics-table {
                font-size: 12px;
            }
            .statistics-table th, .statistics-table td {
                padding: 6px 4px;
            }
            .progress-bar-container {
                height: 15px;
            }
            .progress-label {
                font-size: 12px;
            }
            .chart-container {
                height: 200px;
            }
        }
        
        /* 超小屏幕适配 */
        @media (max-width: 400px) {
            .response-button {
                width: 90px;
                height: 90px;
                font-size: 16px;
                margin: 0 8px;
            }
            .prompt-text {
                font-size: 16px;
            }
            .result-table {
                font-size: 11px;
            }
            .result-table th, .result-table td {
                padding: 4px 2px;
            }
        }
        .print-button {
            padding: 14px 28px;
            margin: 20px auto;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            display: block;
        }
        .print-button:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .print-button:active {
            transform: translateY(1px);
        }
        @media print {
            body {
                background-color: white;
                margin: 0;
                padding: 0;
            }
            .container {
                max-width: 100%;
                box-shadow: none;
                padding: 10px;
            }
            .back-button, .print-button, .auxiliary-buttons {
                display: none;
            }
            .results-container {
                display: block !important;
                box-shadow: none;
                background-color: white;
                padding: 0;
            }
            .chart-container {
                border: 1px solid #ddd;
                background-color: white;
            }
            .result-table th {
                background-color: #f0f0f0 !important;
                color: black !important;
            }
            .result-interpretation {
                background-color: white;
                border: 1px solid #ddd;
            }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .progress-label {
            text-align: center;
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }
        .highlight-box {
            background-color: #fffacd;
            border: 2px solid #ffd700;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .highlight-value {
            font-size: 28px;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
        }
        .experiment-progress {
            text-align: center;
            font-size: 16px;
            color: #2c3e50;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #e8f4f8;
            border-radius: 5px;
            display: inline-block;
            font-weight: 600;
        }
        .experiment-progress span {
            color: #667eea;
            font-weight: bold;
        }
    </style>
    
    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Email Configuration and Service -->
    <script src="js/emailConfig.js"></script>
    <script src="js/emailService.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="Media/animation.gif" alt="Experiment animation">
            <div class="training-info">Mid Falling Tone Discrimination (ABX)</div>
            <div id="experimentProgress" class="experiment-progress" style="display: none;">
                實驗進度: <span id="progressText">1/3</span>
            </div>
            <div class="instruction-text">請判斷第三個音聽起來更像第一個還是第二個音</div>
        </div>

        <div id="experimentContainer">
            <div class="control-button-container">
                <input id="start" type="button" value="開始實驗" onclick="start_onclick()" class="control-button">
                <input id="viewResult" type="button" value="查看結果" onclick="view_onclick()" class="control-button" disabled>
            </div>

            <div class="prompt-text" id="promptText">
                第三個音更像...
            </div>
            
            <div class="button-container">
                <input id="firstBtn" type="button" value="第一個音" onclick="processAnswer(1)" disabled 
                    class="response-button" style="background:#FF6666;">
                <input id="secondBtn" type="button" value="第二個音" onclick="processAnswer(2)" disabled 
                    class="response-button" style="background:#FF6666;">
            </div>

            <div class="feedback">
                <img id="smile" src="Media/null.gif" width="100" height="84" alt="Feedback">
            </div>
            
            <div class="button-container">
                <input id="text1" class="status" readonly>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-label" id="progressLabel">Progress: 0%</div>
            
            <div class="debug-info" id="debugInfo">
                Debug information will be displayed here
            </div>
            
            <div class="auxiliary-buttons">
                <label><input type="checkbox" id="showDebug" onclick="toggleDebug()"> Show Debug Info</label>
                <button onclick="testAudio()">Test All Audio</button>
                <button onclick="showDiagnostics()">Diagnostics</button>
                <button onclick="exportToCSV()" id="exportBtn">Export Data (CSV)</button>
                <button onclick="testEmailSending()" id="testEmailBtn">測試郵件發送</button>
            </div>
        </div>
        
        <div id="resultsContainer" class="results-container">
            <h2 class="result-heading">Dynamic Pitch Discrimination Test Results (ABX)</h2>
            
            <div class="highlight-box">
                <h3 style="margin-top: 0;">Just Noticeable Difference (JND)</h3>
                <div class="highlight-value" id="jndValue">--</div>
                <p style="margin-bottom: 0; font-size: 14px; color: #666;">
                    This represents the minimum detectable difference in modulation window duration<br>
                    <strong>Smaller JND = Better discrimination ability</strong>
                </p>
            </div>
            
            <h3>Perceptual Discrimination Thresholds</h3>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Standard (Reference)</th>
                        <th>Threshold (Your JND)</th>
                        <th>Difference Ratio</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody">
                </tbody>
            </table>
            
            <div class="result-interpretation" id="resultInterpretation">
            </div>
            
            <h3>Detailed Threshold Metrics</h3>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Interpretation</th>
                    </tr>
                </thead>
                <tbody id="detailedMetricsBody">
                </tbody>
            </table>
            
            <h3>Performance Statistics</h3>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="performanceStatsBody">
                </tbody>
            </table>
            
            <button class="print-button" onclick="printResults()">Print Results</button>
            
            <div class="auxiliary-buttons" style="margin-top: 20px;">
                <button onclick="exportToCSV()">Export Data (CSV)</button>
            </div>
            
            <button class="back-button" onclick="backToExperiment()">Back to Experiment</button>
        </div>
        
        <div class="diagnostic-overlay" id="diagnosticOverlay">
            <div class="diagnostic-content">
                <span class="diagnostic-close" onclick="closeDiagnostics()">&times;</span>
                <h2 class="diagnostic-heading">Experiment Diagnostics</h2>
                
                <div class="diagnostic-section">
                    <h3>Test Status</h3>
                    <table class="statistics-table">
                        <tr>
                            <th>Trials</th>
                            <th>Reversals</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td id="totalTrials">0</td>
                            <td id="totalReversals">0</td>
                            <td id="testStatus">Not started</td>
                        </tr>
                    </table>
                </div>
                
                <div class="diagnostic-section">
                    <h3>Audio Files Check</h3>
                    <p>Verifying necessary audio files:</p>
                    <div id="audioFileStatus" class="diagnostic-file-status">
                    </div>
                </div>
                
                <div class="diagnostic-section">
                    <h3>Reversal History</h3>
                    <div id="reversalHistory">
                    </div>
                </div>
                
                <div class="diagnostic-section">
                    <h3>Recommendations</h3>
                    <div id="diagnosticRecommendations">
                    </div>
                </div>
                
                <div class="diagnostic-actions">
                    <button class="diagnostic-action-button continue-button" onclick="closeDiagnostics()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="mid_falling_standard" src="Media/mid_falling_standard.wav" preload="auto"></audio>

    <audio id="mid_falling_1" src="Media/mid_falling_1.wav" preload="auto"></audio>
    <audio id="mid_falling_2" src="Media/mid_falling_2.wav" preload="auto"></audio>
    <audio id="mid_falling_3" src="Media/mid_falling_3.wav" preload="auto"></audio>
    <audio id="mid_falling_4" src="Media/mid_falling_4.wav" preload="auto"></audio>
    <audio id="mid_falling_5" src="Media/mid_falling_5.wav" preload="auto"></audio>
    <audio id="mid_falling_6" src="Media/mid_falling_6.wav" preload="auto"></audio>
    <audio id="mid_falling_7" src="Media/mid_falling_7.wav" preload="auto"></audio>
    <audio id="mid_falling_8" src="Media/mid_falling_8.wav" preload="auto"></audio>
    <audio id="mid_falling_9" src="Media/mid_falling_9.wav" preload="auto"></audio>
    <audio id="mid_falling_10" src="Media/mid_falling_10.wav" preload="auto"></audio>

<script>
function getLocalTimestamp() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
    
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
}

// Stimulus parameters for dynamic pitch modulation
const STIMULUS_DURATION = 450; // ms, total duration
const STANDARD_WINDOW = 400; // ms, modulation window for standard (100%)
const STANDARD_WINDOW_PERCENT = 100; // percentage

// Modulation window percentages for each difficulty level (10 levels)
const MODULATION_WINDOWS = {
    1: 10,   // easiest - 10% of standard window (40 ms)
    2: 20,   // 80 ms
    3: 30,   // 120 ms
    4: 40,   // 160 ms
    5: 50,   // 200 ms
    6: 60,   // 240 ms
    7: 70,   // 280 ms
    8: 80,   // 320 ms
    9: 90,   // 360 ms
    10: 95   // hardest - 95% of standard window (380 ms)
};

function getModulationWindowDuration(level) {
    return (MODULATION_WINDOWS[level] / 100) * STANDARD_WINDOW;
}

const PITCH_FALL_SEMITONES = 1.0;

function getModulationRate(level) {
    const windowDuration = getModulationWindowDuration(level);
    const windowDurationSec = windowDuration / 1000;
    return PITCH_FALL_SEMITONES / windowDurationSec;
}

function getModulationSlope(level) {
    const windowDuration = getModulationWindowDuration(level);
    return PITCH_FALL_SEMITONES / windowDuration;
}

// Adaptive threshold experiment constants
const MAXREVERSALS = 10;
const MAXITERATIONS = 50;
const LOWERLIMIT = 1;
const UPPERLIMIT = 10;
const DECREASING = -1;
const INCREASING = 1;
const MINIMUMREVERSALS = 6;
const THRESHOLD_REVERSAL_COUNT = 6;
const MAX_REPEAT_COUNT = 3; // 最大重复次数

// Experiment state variables
var CorrectAnswer;
var CorrectResponses = 0;
var Direction = DECREASING;
var Reversals = [];
var NumberOfReversals = 0;
var currentLevel = 5;
var numberOfIterations = 0;
var sentAverage = 0.0;
var sentStdev = 0.0;
var isTestComplete = false;
var audioUnlocked = false;
var allFilesPresent = true;
var trialRecords = [];
var stimulusEndTime = 0;

// ABX variables
var standardIsFirst;
var comparisonSound;
var standardSound;
var xSound;

var isReplayTrial = false;
var currentRepeatCount = 0; // 当前重复计数

// 邮件发送状态变量（防止重复发送）
var emailSent = false;

// Results variables - JND-based
var jndAbsoluteDifference = 0;
var jndRatio = 0;
var jndPercentDifference = 0;
var thresholdWindowDuration = 0;
var thresholdWindowPercent = 0;
var thresholdModulationRate = 0;
var thresholdSlope = 0;
var webersRatio = 0;

function printResults() {
    window.print();
}

function logDebug(message) {
    console.log(message);
    var debugArea = document.getElementById('debugInfo');
    var now = new Date();
    var timeStr = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + '.' + now.getMilliseconds();
    debugArea.innerHTML += '<p>[' + timeStr + '] ' + message + '</p>';
    debugArea.scrollTop = debugArea.scrollHeight;
}

function toggleDebug() {
    var debugArea = document.getElementById('debugInfo');
    var checkbox = document.getElementById('showDebug');
    debugArea.style.display = checkbox.checked ? 'block' : 'none';
}

function showDiagnostics() {
    updateDiagnostics();
    document.getElementById('diagnosticOverlay').style.display = 'flex';
}

function closeDiagnostics() {
    document.getElementById('diagnosticOverlay').style.display = 'none';
}

function updateDiagnostics() {
    document.getElementById('totalTrials').innerText = numberOfIterations;
    document.getElementById('totalReversals').innerText = NumberOfReversals;
    
    let testStatus = getTestStatus();
    document.getElementById('testStatus').innerText = testStatus.text;
    document.getElementById('testStatus').className = `direction-stats-${testStatus.class}`;
    
    checkAudioFiles();
    
    let reversalHistoryHtml = '';
    if (Reversals.length === 0) {
        reversalHistoryHtml += '<p>No reversals recorded yet</p>';
    } else {
        reversalHistoryHtml += '<p>Reversals at difficulty levels: ' + Reversals.join(', ') + '</p>';
        reversalHistoryHtml += '<p>Corresponding modulation windows: ';
        reversalHistoryHtml += Reversals.map(level => MODULATION_WINDOWS[level] + '% (' + getModulationWindowDuration(level) + ' ms)').join(', ') + '</p>';
    }
    
    document.getElementById('reversalHistory').innerHTML = reversalHistoryHtml;
    
    generateDiagnosticRecommendations();
}

function getTestStatus() {
    if (isTestComplete) {
        return { text: "Complete", class: "good" };
    }
    
    if (NumberOfReversals < 1) {
        return { text: "Not enough data", class: "bad" };
    }
    
    if (NumberOfReversals < MINIMUMREVERSALS) {
        return { text: "Incomplete (" + NumberOfReversals + "/" + MINIMUMREVERSALS + " reversals)", class: "warning" };
    }
    
    return { text: "In progress", class: "good" };
}

function checkAudioFiles() {
    const requiredFiles = [
        "mid_falling_standard",
        "mid_falling_1", "mid_falling_2", "mid_falling_3", "mid_falling_4", "mid_falling_5", 
        "mid_falling_6", "mid_falling_7", "mid_falling_8", "mid_falling_9", "mid_falling_10"
    ];
    
    let statusHtml = '';
    allFilesPresent = true;
    
    requiredFiles.forEach(function(fileId) {
        const audioElement = document.getElementById(fileId);
        const fileFound = audioElement !== null;
        
        if (!fileFound) {
            allFilesPresent = false;
        }
        
        statusHtml += `<div class="file-status-item ${fileFound ? 'file-found' : 'file-missing'}">${fileId}: ${fileFound ? 'Found' : 'Missing'}</div>`;
    });
    
    document.getElementById('audioFileStatus').innerHTML = statusHtml;
}

function generateDiagnosticRecommendations() {
    let recommendations = '';
    let hasIssues = false;
    
    if (!allFilesPresent) {
        recommendations += '<p><strong>Critical Issue:</strong> Some required audio files are missing. Please ensure all files are properly loaded.</p>';
        hasIssues = true;
    }
    
    if (numberOfIterations >= MAXITERATIONS && NumberOfReversals < MINIMUMREVERSALS) {
        recommendations += '<p><strong>Issue:</strong> Reached maximum trials but has insufficient reversals. This might indicate audio file issues or participant response patterns.</p>';
        hasIssues = true;
    }
    
    if (!hasIssues) {
        recommendations += '<p><strong>Good:</strong> No major issues detected with the experiment setup.</p>';
        
        if (isTestComplete) {
            recommendations += '<p>Test is complete.</p>';
        } else {
            recommendations += '<p>Test is still in progress.</p>';
        }
    }
    
    document.getElementById('diagnosticRecommendations').innerHTML = recommendations;
}

function testAudio() {
    logDebug("Starting to test all audio files...");
    var audios = document.querySelectorAll('audio');
    
    if (!audioUnlocked) {
        unlockAudioContext();
    }
    
    var index = 0;
    function playNext() {
        if (index >= audios.length) {
            logDebug("All audio testing complete!");
            return;
        }
        
        var audio = audios[index];
        logDebug("Testing audio #" + (index + 1) + ": " + audio.id);
        
        audio.currentTime = 0;
        
        var playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.then(function() {
                logDebug(audio.id + " played successfully");
                
                audio.onended = function() {
                    logDebug(audio.id + " playback ended");
                    index++;
                    setTimeout(playNext, 500);
                };
            }).catch(function(error) {
                logDebug("Failed to play " + audio.id + ": " + error);
                index++;
                setTimeout(playNext, 500);
            });
        }
    }
    
    playNext();
}

function unlockAudioContext() {
    logDebug("Attempting to unlock audio context...");
    
    var silentAudio = new Audio();
    silentAudio.src = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA";
    
    var promise = silentAudio.play();
    if (promise !== undefined) {
        promise.then(function() {
            logDebug("Audio context unlocked successfully");
            silentAudio.remove();
            audioUnlocked = true;
        }).catch(function(error) {
            logDebug("Failed to unlock audio context: " + error);
        });
    }
    
    // 解锁所有实际的音频元素（对 Safari/iOS 很重要）
    var allAudios = document.querySelectorAll('audio');
    allAudios.forEach(function(audio) {
        audio.muted = true;
        var playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.then(function() {
                audio.pause();
                audio.currentTime = 0;
                audio.muted = false;
            }).catch(function() {
                audio.muted = false;
            });
        }
    });
    
    logDebug("Attempted to unlock " + allAudios.length + " audio files for Safari/iOS");
}

/**
 * 延迟函数
 * @param {number} ms - 延迟毫秒数
 */
function delay(ms) {
    return new Promise(function(resolve) {
        setTimeout(resolve, ms);
    });
}

/**
 * 等待音频缓冲完成（解决 Chrome 因缓冲不足导致的卡顿）
 * @param {HTMLAudioElement} audio - 音频元素
 * @param {number} timeout - 最大等待时间（毫秒）
 */
function waitForAudioReady(audio, timeout) {
    return new Promise(function(resolve) {
        timeout = timeout || 5000;
        
        // readyState >= 3 (HAVE_FUTURE_DATA) 表示有足够数据可以播放
        if (audio.readyState >= 3) {
            logDebug("Audio " + audio.id + " already buffered (readyState: " + audio.readyState + ")");
            resolve();
            return;
        }
        
        logDebug("Audio " + audio.id + " waiting for buffer (readyState: " + audio.readyState + ")");
        
        var resolved = false;
        
        var onCanPlay = function() {
            if (!resolved) {
                resolved = true;
                audio.removeEventListener('canplaythrough', onCanPlay);
                logDebug("Audio " + audio.id + " buffered and ready");
                resolve();
            }
        };
        
        // 监听 canplaythrough 事件
        audio.addEventListener('canplaythrough', onCanPlay);
        
        // 超时保护 - 避免无限等待
        setTimeout(function() {
            if (!resolved) {
                resolved = true;
                audio.removeEventListener('canplaythrough', onCanPlay);
                logDebug("Audio " + audio.id + " buffer timeout, proceeding anyway");
                resolve();
            }
        }, timeout);
        
        // 尝试触发加载
        if (audio.readyState === 0) {
            audio.load();
        }
    });
}

/**
 * 可靠的音频播放函数（带缓冲检查和超时保护）
 * - 解决 Chrome 因缓冲不足导致的卡顿
 * - 解决 Safari onended 事件不触发问题
 * @param {HTMLAudioElement} audio - 音频元素
 * @param {number} timeout - 超时时间（毫秒），默认基于音频时长 + 2秒
 */
function playAudioWithTimeout(audio, timeout) {
    return new Promise(function(resolve, reject) {
        // 首先等待音频缓冲完成
        waitForAudioReady(audio, 3000).then(function() {
            var resolved = false;
            
            // 计算超时时间：音频时长 + 2秒缓冲，最少3秒
            var timeoutMs = timeout || Math.max(3000, (audio.duration || 1) * 1000 + 2000);
            
            var onEnd = function() {
                if (!resolved) {
                    resolved = true;
                    audio.removeEventListener('ended', onEnd);
                    logDebug("Audio " + audio.id + " ended normally");
                    resolve();
                }
            };
            
            // 使用 addEventListener 替代 onended（更可靠）
            audio.addEventListener('ended', onEnd);
            
            // 超时保护 - Safari 如果 ended 事件没触发
            setTimeout(function() {
                if (!resolved) {
                    resolved = true;
                    audio.removeEventListener('ended', onEnd);
                    logDebug("Audio " + audio.id + " timeout, forcing next step");
                    resolve();
                }
            }, timeoutMs);
            
            audio.currentTime = 0;
            var playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(function(err) {
                    if (!resolved) {
                        resolved = true;
                        audio.removeEventListener('ended', onEnd);
                        logDebug("Audio " + audio.id + " play failed: " + err);
                        reject(err);
                    }
                });
            }
        });
    });
}

function resetPage() {
    numberOfIterations++;
    document.getElementById('firstBtn').disabled = true;
    document.getElementById('secondBtn').disabled = true;
    document.getElementById('firstBtn').style.background = "#FF6666";
    document.getElementById('secondBtn').style.background = "#FF6666";
    document.getElementById('promptText').style.visibility = 'hidden';
    
    if (isTestComplete) {
        document.getElementById('start').disabled = false;
        document.getElementById('viewResult').disabled = false;
        document.getElementById('text1').value = "實驗結束！";
        updateProgressBar(100);
        return;
    }
    
    if ((numberOfIterations >= MAXITERATIONS) || (NumberOfReversals >= MAXREVERSALS)) {
        if (NumberOfReversals >= MINIMUMREVERSALS) {
            calculateResults();
            isTestComplete = true;
            document.getElementById('start').disabled = false;
            document.getElementById('viewResult').disabled = false;
            document.getElementById('text1').value = "實驗結束！";
            updateProgressBar(100);
        } else {
            logDebug("Reached max iterations but has only " + NumberOfReversals + "/" + MINIMUMREVERSALS + " reversals. Showing diagnostics.");
            document.getElementById('text1').value = "Insufficient data. Check diagnostics.";
            setTimeout(function() {
                showDiagnostics();
            }, 500);
            return;
        }
    } else {
        updateProgressBar();
        beginIteration();
    }
}

function updateProgressBar(forcePercent) {
    if (typeof forcePercent === 'number') {
        document.getElementById('progressBar').style.width = forcePercent + '%';
        document.getElementById('progressLabel').textContent = 'Progress: ' + forcePercent + '%';
        return;
    }
    
    const maxValue = Math.max(MAXREVERSALS, MAXITERATIONS);
    const currentValue = isTestComplete ? maxValue : Math.max(NumberOfReversals, numberOfIterations);
    const totalPercent = Math.min(100 * (currentValue / maxValue), 100);
    
    document.getElementById('progressBar').style.width = totalPercent + '%';
    document.getElementById('progressLabel').textContent = 'Progress: ' + Math.round(totalPercent) + '%';
}

function calculateResults() {
    let sum = 0.0, stddevsum = 0.0, average = 0.0, stdev = 0.0, counter = 0;
    
    for (let i = 0; i < Reversals.length; i++) {
        if (Reversals[i] > 0) counter++;
    }
    
    if (counter < MINIMUMREVERSALS) {
        logDebug("Test has insufficient data");
        alert("Test has insufficient data. Please complete the test again.");
        return;
    }
    
    const startIndex = Math.max(0, NumberOfReversals - THRESHOLD_REVERSAL_COUNT);
    counter = 0;
    
    for (let i = startIndex; i < Reversals.length; i++) {
        const level = Reversals[i];
        if (level > 0) {
            sum += level;
            counter++;
        }
    }
    
    if (counter > 0) {
        average = sum / counter;
        average = parseFloat(average.toFixed(2));
    }
    
    for (let i = startIndex; i < Reversals.length; i++) {
        const level = Reversals[i];
        if (level > 0) {
            stddevsum += Math.pow(level - average, 2);
        }
    }
    
    if (counter > 1) {
        stdev = Math.sqrt(stddevsum / (counter - 1));
        stdev = parseFloat(stdev.toFixed(2));
    }
    
    sentAverage = average;
    sentStdev = stdev;
    
    thresholdWindowPercent = calculateAverageWindowPercent(startIndex);
    thresholdWindowDuration = (thresholdWindowPercent / 100) * STANDARD_WINDOW;
    thresholdModulationRate = PITCH_FALL_SEMITONES / (thresholdWindowDuration / 1000);
    thresholdSlope = PITCH_FALL_SEMITONES / thresholdWindowDuration;
    
    jndAbsoluteDifference = STANDARD_WINDOW - thresholdWindowDuration;
    jndRatio = thresholdWindowDuration / STANDARD_WINDOW;
    jndPercentDifference = 100 - thresholdWindowPercent;
    webersRatio = jndAbsoluteDifference / STANDARD_WINDOW;
    
    logDebug("Test complete! Average difficulty level: " + average.toFixed(2));
    logDebug("Threshold window: " + thresholdWindowPercent.toFixed(2) + "% (" + thresholdWindowDuration.toFixed(2) + " ms)");
    logDebug("JND Absolute Difference: " + jndAbsoluteDifference.toFixed(2) + " ms");
    logDebug("JND Ratio: " + jndRatio.toFixed(4));
    logDebug("JND Percent Difference: " + jndPercentDifference.toFixed(2) + "%");
    logDebug("Weber's Ratio: " + webersRatio.toFixed(4));
    
    document.getElementById('text1').value = "Test complete! JND: " + jndAbsoluteDifference.toFixed(1) + " ms";
    
    // 自动发送实验结果到指定邮箱（防止重复发送）
    if (!emailSent) {
        emailSent = true;
        logDebug("Preparing to send experiment results via email...");
        
        // 延迟1秒后发送邮件，确保所有数据已准备好
        setTimeout(function() {
            if (typeof sendCurrentExperimentResults === 'function') {
                sendCurrentExperimentResults();
                logDebug("Email sending initiated");
            } else {
                logDebug("Warning: Email service not available. Please check if emailService.js is loaded.");
            }
        }, 1000);
    } else {
        logDebug("Email already sent, skipping duplicate send");
    }
}

function calculateAverageWindowPercent(startIndex) {
    let sum = 0;
    let count = 0;
    
    for (let i = startIndex; i < Reversals.length; i++) {
        const level = Reversals[i];
        if (level > 0 && MODULATION_WINDOWS[level] !== undefined) {
            sum += MODULATION_WINDOWS[level];
            count++;
        }
    }
    
    return count > 0 ? sum / count : 0;
}

function calculateReactionTimeStats() {
    let allRTs = trialRecords.map(t => parseFloat(t.reactionTime));
    
    return {
        mean: allRTs.length ? (allRTs.reduce((a, b) => a + b, 0) / allRTs.length).toFixed(0) : "N/A",
        median: allRTs.length ? calculateMedian(allRTs).toFixed(0) : "N/A",
        sd: allRTs.length > 1 ? calculateSD(allRTs).toFixed(0) : "N/A"
    };
}

function calculateAccuracyStats() {
    let allTrials = trialRecords;
    
    return {
        correct: allTrials.filter(t => t.isCorrect).length,
        total: allTrials.length,
        percentage: allTrials.length ? 
            (allTrials.filter(t => t.isCorrect).length / allTrials.length * 100).toFixed(1) : "N/A"
    };
}

function calculateMedian(values) {
    if (!values.length) return 0;
    
    const sortedValues = values.slice().sort((a, b) => a - b);
    const mid = Math.floor(sortedValues.length / 2);
    
    return sortedValues.length % 2 === 0 ? 
        (sortedValues[mid - 1] + sortedValues[mid]) / 2 : 
        sortedValues[mid];
}

function calculateSD(values) {
    if (values.length <= 1) return 0;
    
    const mean = values.reduce((a, b) => a + b, 0) / values.length;
    const variance = values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / (values.length - 1);
    
    return Math.sqrt(variance);
}

function displayResults() {
    logDebug("Displaying results");
    
    let hasData = NumberOfReversals >= MINIMUMREVERSALS;
    
    if (!hasData) {
        let message = "Warning: Insufficient data. Results may not be reliable.";
        
        if (confirm(message + "\n\nWould you like to retry the experiment?")) {
            window_onload();
            return;
        }
    }
    
    document.getElementById('experimentContainer').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'block';
    
    if (hasData) {
        document.getElementById('jndValue').innerHTML = 
            jndAbsoluteDifference.toFixed(2) + ' ms<br>' +
            '<span style="font-size: 18px;">(' + jndPercentDifference.toFixed(2) + '% difference from standard)</span>';
    } else {
        document.getElementById('jndValue').textContent = 'Insufficient Data';
    }
    
    var tableBody = document.getElementById('resultTableBody');
    tableBody.innerHTML = '';
    
    var windowRow = document.createElement('tr');
    windowRow.innerHTML = 
        '<td>Modulation Window Duration</td>' +
        '<td>' + STANDARD_WINDOW + ' ms (100%)</td>' +
        '<td>' + (hasData ? thresholdWindowDuration.toFixed(2) + ' ms (' + thresholdWindowPercent.toFixed(2) + '%)' : 'N/A') + '</td>' +
        '<td>' + (hasData ? jndRatio.toFixed(4) + ' : 1<br>(Threshold/Standard)' : 'N/A') + '</td>';
    tableBody.appendChild(windowRow);
    
    var diffRow = document.createElement('tr');
    diffRow.innerHTML = 
        '<td>Absolute Difference (JND)</td>' +
        '<td>0 ms (reference)</td>' +
        '<td>' + (hasData ? jndAbsoluteDifference.toFixed(2) + ' ms' : 'N/A') + '</td>' +
        '<td>' + (hasData ? 'Weber Ratio: ' + webersRatio.toFixed(4) : 'N/A') + '</td>';
    tableBody.appendChild(diffRow);
    
    var rateStandard = PITCH_FALL_SEMITONES / (STANDARD_WINDOW / 1000);
    var rateRow = document.createElement('tr');
    rateRow.innerHTML = 
        '<td>Modulation Rate</td>' +
        '<td>' + rateStandard.toFixed(4) + ' semitones/s</td>' +
        '<td>' + (hasData ? thresholdModulationRate.toFixed(4) + ' semitones/s' : 'N/A') + '</td>' +
        '<td>' + (hasData ? (thresholdModulationRate / rateStandard).toFixed(4) + ' : 1' : 'N/A') + '</td>';
    tableBody.appendChild(rateRow);
    
    var interpretation = document.getElementById('resultInterpretation');
    let interpretationHtml = '<h3 style="margin-top: 0;">Performance Interpretation</h3>';
    
    if (hasData) {
        interpretationHtml += '<p><strong>Your Just Noticeable Difference (JND):</strong></p>';
        
        interpretationHtml += '<p>You can reliably detect a difference when the modulation window changes by <strong>' + 
            jndAbsoluteDifference.toFixed(2) + ' ms</strong> (or <strong>' + jndPercentDifference.toFixed(2) + 
            '%</strong> of the standard 400 ms window).</p>';
        
        interpretationHtml += '<p>In other words, you can discriminate between:</p>';
        interpretationHtml += '<ul>';
        interpretationHtml += '<li>Standard stimulus: 400 ms modulation window</li>';
        interpretationHtml += '<li>Your threshold: ' + thresholdWindowDuration.toFixed(2) + ' ms modulation window</li>';
        interpretationHtml += '<li>Difference: ' + jndAbsoluteDifference.toFixed(2) + ' ms</li>';
        interpretationHtml += '</ul>';
        
        interpretationHtml += '<p><strong>Weber\'s Ratio:</strong> ' + webersRatio.toFixed(4) + 
            ' (smaller Weber\'s ratio = better discrimination sensitivity)</p>';
        
        interpretationHtml += '<p><em>Note: A <strong>smaller JND</strong> indicates <strong>better sensitivity</strong> to dynamic pitch changes, ' +
            'as it means you can detect smaller differences between stimuli.</em></p>';
    } else {
        interpretationHtml += '<p><strong>Note:</strong> Complete results not available due to insufficient data.</p>';
    }
    
    const rtStats = calculateReactionTimeStats();
    const accuracyStats = calculateAccuracyStats();
    
    interpretationHtml += '<p><strong>Overall Performance:</strong> ' + accuracyStats.percentage + 
        '% accuracy with average reaction time of ' + rtStats.mean + ' ms across ' + 
        accuracyStats.total + ' trials.</p>';
    
    interpretation.innerHTML = interpretationHtml;
    
    var detailedBody = document.getElementById('detailedMetricsBody');
    detailedBody.innerHTML = '';
    
    var metrics = [
        { name: 'Average Difficulty Level', value: hasData ? sentAverage.toFixed(2) : 'N/A', interp: hasData ? 'SD: ' + sentStdev.toFixed(2) : 'N/A' },
        { name: 'Threshold Slope', value: hasData ? thresholdSlope.toFixed(6) + ' semitones/ms' : 'N/A', interp: hasData ? 'Rate of pitch change' : 'N/A' },
        { name: 'Number of Reversals', value: NumberOfReversals, interp: 'Minimum required: ' + MINIMUMREVERSALS },
        { name: 'Total Trials', value: numberOfIterations, interp: 'Maximum allowed: ' + MAXITERATIONS }
    ];
    
    metrics.forEach(function(metric) {
        var row = document.createElement('tr');
        row.innerHTML = '<td>' + metric.name + '</td><td>' + metric.value + '</td><td>' + metric.interp + '</td>';
        detailedBody.appendChild(row);
    });
    
    var perfBody = document.getElementById('performanceStatsBody');
    perfBody.innerHTML = '';
    
    var perfMetrics = [
        { name: 'Total Trials', value: accuracyStats.total },
        { name: 'Correct Responses', value: accuracyStats.correct },
        { name: 'Overall Accuracy', value: accuracyStats.percentage + '%' },
        { name: 'Mean Reaction Time', value: rtStats.mean + ' ms' },
        { name: 'Median Reaction Time', value: rtStats.median + ' ms' },
        { name: 'RT Standard Deviation', value: rtStats.sd + ' ms' }
    ];
    
    perfMetrics.forEach(function(metric) {
        var row = document.createElement('tr');
        row.innerHTML = '<td>' + metric.name + '</td><td>' + metric.value + '</td>';
        perfBody.appendChild(row);
    });
}

function backToExperiment() {
    document.getElementById('experimentContainer').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';
}

function view_onclick() {
    logDebug("View results button clicked");
    
    if (!isTestComplete && NumberOfReversals >= MINIMUMREVERSALS) {
        calculateResults();
        isTestComplete = true;
    }
    
    displayResults();
}

function beginIteration() {
    isReplayTrial = false;
    currentRepeatCount = 0; // 重置重复计数
    
    standardIsFirst = Math.random() < 0.5;
    var xIsStandard = Math.random() < 0.5;
    
    if (xIsStandard) {
        CorrectAnswer = standardIsFirst ? 1 : 2;
    } else {
        CorrectAnswer = standardIsFirst ? 2 : 1;
    }
    
    logDebug("Starting new iteration #" + numberOfIterations + 
             ", Standard is " + (standardIsFirst ? "first" : "second") +
             ", X is " + (xIsStandard ? "standard" : "comparison") +
             ", Correct answer: " + (CorrectAnswer === 1 ? "First" : "Second") +
             ", Difficulty level: " + currentLevel +
             ", Modulation window: " + MODULATION_WINDOWS[currentLevel] + "% (" + 
             getModulationWindowDuration(currentLevel) + " ms)");
    
    setTimeout(function() {
        playABXSequence(xIsStandard);
    }, 1000);
}

function clearButtonAnimations() {
    document.getElementById('firstBtn').classList.remove('button-playing');
    document.getElementById('secondBtn').classList.remove('button-playing');
}

async function playABXSequence(xIsStandard) {
    logDebug("Playing ABX sequence");
    
    clearButtonAnimations();
    
    standardSound = document.getElementById('mid_falling_standard');
    comparisonSound = document.getElementById("mid_falling_" + currentLevel);
    
    xSound = xIsStandard ? standardSound : comparisonSound;
    
    if (!standardSound || !comparisonSound) {
        logDebug("Error: Cannot find audio elements!");
        document.getElementById('text1').value = "出錯：找不到音頻文件";
        setTimeout(function() {
            showDiagnostics();
        }, 1000);
        return;
    }
    
    var firstSound = standardIsFirst ? standardSound : comparisonSound;
    var secondSound = standardIsFirst ? comparisonSound : standardSound;
    
    try {
        // 播放第一個音
        document.getElementById('text1').value = "播放第一個音";
        document.getElementById('firstBtn').classList.add('button-playing');
        logDebug("Playing first sound (A)...");
        await playAudioWithTimeout(firstSound);
        document.getElementById('firstBtn').classList.remove('button-playing');
        
        // 間隔
        await delay(1000);
        
        // 播放第二個音
        document.getElementById('text1').value = "播放第二個音";
        document.getElementById('secondBtn').classList.add('button-playing');
        logDebug("Playing second sound (B)...");
        await playAudioWithTimeout(secondSound);
        document.getElementById('secondBtn').classList.remove('button-playing');
        
        // 間隔
        await delay(1000);
        
        // 播放第三個音 (X)
        document.getElementById('text1').value = "播放第三個音";
        logDebug("Playing third sound (X)...");
        await playAudioWithTimeout(xSound);
        
        // 啟用按鈕讓用戶選擇
        logDebug("All sounds played, enabling response buttons");
        stimulusEndTime = performance.now();
        
        document.getElementById('text1').value = "請作出選擇";
        document.getElementById('promptText').style.visibility = 'visible';
        
        document.getElementById('firstBtn').disabled = false;
        document.getElementById('secondBtn').disabled = false;
        document.getElementById('firstBtn').style.background = "#66CCFF";
        document.getElementById('secondBtn').style.background = "#66CCFF";
        
    } catch (error) {
        logDebug("Audio playback error: " + error);
        document.getElementById('text1').value = "音頻播放錯誤，請刷新頁面";
        clearButtonAnimations();
        setTimeout(showDiagnostics, 1000);
    }
}

function start_onclick() {
    logDebug("Starting experiment");
    
    // 记录实验开始时间（如果还没记录的话）
    if (!window.experimentStartTime) {
        const startTime = new Date().toLocaleString('zh-CN');
        window.experimentStartTime = startTime;
        localStorage.setItem('experimentStartTime', startTime);
        logDebug("Experiment start time recorded: " + startTime);
    }
    
    if (!audioUnlocked) {
        unlockAudioContext();
    }
    
    checkAudioFiles();
    if (!allFilesPresent) {
        logDebug("Cannot start experiment: Some audio files are missing");
        document.getElementById('text1').value = "音頻缺失";
        showDiagnostics();
        return;
    }
    
    window_onload();
    document.getElementById('text1').value = "開始實驗...";
    updateProgressBar(0);
    
    setTimeout(function() {
        beginIteration();
        document.getElementById('start').disabled = true;
        document.getElementById('viewResult').disabled = true;
        document.getElementById('smile').src = "Media/null.gif";
        document.getElementById('promptText').style.visibility = 'hidden';
    }, 1000);
}

function gotReversal() {
    NumberOfReversals++;
    Reversals[NumberOfReversals - 1] = currentLevel;
    Direction = -Direction;
    logDebug("Recorded reversal #" + NumberOfReversals + " at difficulty " + currentLevel + 
             " (window: " + MODULATION_WINDOWS[currentLevel] + "%, " + 
             getModulationWindowDuration(currentLevel) + " ms)");
}

function processAnswer(Response) {
    const reactionEndTime = performance.now();
    const reactionTime = reactionEndTime - stimulusEndTime;
    
    logDebug("User answered: " + (Response === 1 ? "First" : "Second") + 
             ", Correct answer: " + (CorrectAnswer === 1 ? "First" : "Second") +
             ", Is replay: " + isReplayTrial +
             ", Repeat count: " + currentRepeatCount);
    
    document.getElementById('firstBtn').disabled = true;
    document.getElementById('secondBtn').disabled = true;
    document.getElementById('promptText').style.visibility = 'hidden';
    
    const isCorrect = (Response === CorrectAnswer);
    
    if (!isReplayTrial) {
        const windowPercent = MODULATION_WINDOWS[currentLevel];
        const windowDuration = getModulationWindowDuration(currentLevel);
        const modulationRate = getModulationRate(currentLevel);
        const slope = getModulationSlope(currentLevel);
        
        const trialInfo = {
            trialNumber: numberOfIterations,
            timestamp: getLocalTimestamp(),
            difficultyLevel: currentLevel,
            modulationWindowPercent: windowPercent,
            modulationWindowDuration: windowDuration.toFixed(2),
            modulationRate: modulationRate.toFixed(4),
            slope: slope.toFixed(6),
            userResponse: Response === 1 ? "First Tone" : "Second Tone",
            correctResponse: CorrectAnswer === 1 ? "First Tone" : "Second Tone",
            isCorrect: isCorrect,
            reactionTime: reactionTime.toFixed(0),
            isReversal: false,
            stepDirection: Direction === DECREASING ? "Increasing Difficulty" : "Decreasing Difficulty",
            standardPosition: standardIsFirst ? "First" : "Second"
        };
        
        trialRecords.push(trialInfo);
    }
    
    if (isCorrect) {
        logDebug("Correct answer");
        document.getElementById('smile').src = "Media/smiley.png";
        document.getElementById('text1').value = "正確！";
        
        if (!isReplayTrial) {
            CorrectResponses++;
            
            // 2-down-1-up: 连续2次正确才降低难度
            if (CorrectResponses >= 2) {
                logDebug("Two correct answers in a row - decreasing difficulty");
                CorrectResponses = 0;
                
                if (Direction == INCREASING) {
                    gotReversal();
                    if (trialRecords.length > 0) {
                        trialRecords[trialRecords.length-1].isReversal = true;
                    }
                }
                
                changeLevel(DECREASING);
            }
        }
        
        setTimeout(function() {
            document.getElementById("smile").src = 'Media/null.gif';
            resetPage();
        }, 1500);
    } else {
        logDebug("Incorrect answer");
        document.getElementById('smile').src = "Media/nosmiley.png";
        
        var correctAnswerText = CorrectAnswer === 1 ? "第一個音" : "第二個音";
        
        if (!isReplayTrial) {
            CorrectResponses = 0; // 重置连续正确计数
            
            if (Direction == DECREASING) {
                gotReversal();
                if (trialRecords.length > 0) {
                    trialRecords[trialRecords.length-1].isReversal = true;
                }
            }
            
            // 1-up: 1次错误就增加难度
            changeLevel(INCREASING);
        }
        
        // 检查是否已达到最大重复次数
        if (currentRepeatCount >= MAX_REPEAT_COUNT) {
            logDebug("Reached maximum repeat count (" + MAX_REPEAT_COUNT + "), moving to next trial");
            document.getElementById('text1').value = "錯誤！正確答案是：" + correctAnswerText + " (已達最大重複次數)";
            
            setTimeout(function() {
                document.getElementById("smile").src = 'Media/null.gif';
                resetPage();
            }, 2000);
        } else {
            currentRepeatCount++;
            logDebug("Will replay stimulus (attempt " + currentRepeatCount + "/" + MAX_REPEAT_COUNT + ")");
            document.getElementById('text1').value = "錯誤！正確答案是：" + correctAnswerText + " (重複 " + currentRepeatCount + "/" + MAX_REPEAT_COUNT + ")";
            
            setTimeout(function() {
                document.getElementById("smile").src = 'Media/null.gif';
                document.getElementById('text1').value = "重播刺激音...";
                
                setTimeout(function() {
                    isReplayTrial = true;
                    
                    var xIsStandard = (standardIsFirst && CorrectAnswer === 1) || 
                                      (!standardIsFirst && CorrectAnswer === 2);
                    playABXSequence(xIsStandard);
                }, 1000);
            }, 2000);
        }
    }
}

function changeLevel(whichWay) {
    var oldLevel = currentLevel;
    var stepSize = 1;
    
    if (whichWay == DECREASING) {
        currentLevel = Math.min(UPPERLIMIT, currentLevel + stepSize);
    } else {
        currentLevel = Math.max(LOWERLIMIT, currentLevel - stepSize);
    }
    
    logDebug("Difficulty changed from level " + oldLevel + " (" + MODULATION_WINDOWS[oldLevel] + "%, " +
             getModulationWindowDuration(oldLevel) + " ms) to level " + 
             currentLevel + " (" + MODULATION_WINDOWS[currentLevel] + "%, " +
             getModulationWindowDuration(currentLevel) + " ms) " +
             (whichWay == DECREASING ? "(increasing difficulty)" : "(decreasing difficulty)"));
}

function testEmailSending() {
    logDebug("Testing email sending functionality...");
    
    // 检查EmailJS是否已加载
    if (typeof emailjs === 'undefined') {
        alert('EmailJS庫未加載！請檢查網絡連接。');
        logDebug("Error: EmailJS library not loaded");
        return;
    }
    
    // 检查是否有实验数据
    if (trialRecords.length === 0) {
        alert('沒有實驗數據！請先完成至少一次試驗。');
        logDebug("Warning: No trial data available for testing");
        return;
    }
    
    // 确认发送
    if (!confirm('確定要發送測試郵件嗎？\n\n這將發送當前的實驗數據到配置的郵箱。\n\n注意：這是測試功能，不會影響實驗完成後的自動發送。')) {
        logDebug("Email test cancelled by user");
        return;
    }
    
    // 禁用按钮防止重复点击
    const testBtn = document.getElementById('testEmailBtn');
    const originalText = testBtn.textContent;
    testBtn.disabled = true;
    testBtn.textContent = '發送中...';
    
    logDebug("Initiating TEST email send (will not affect auto-send)...");
    
    // 直接发送测试邮件，不影响 emailSent 状态，不触发页面跳转
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const participantId = urlParams.get('participantId') || localStorage.getItem('participantId') || 'N/A';
        const sessionNumber = urlParams.get('sessionNumber') || localStorage.getItem('sessionNumber') || 'N/A';
        
        // 生成简化的测试 CSV
        const csvRows = [];
        csvRows.push("Participant ID: " + participantId);
        csvRows.push("Session Number: " + sessionNumber);
        csvRows.push("NOTE: This is a TEST email");
        csvRows.push("");
        
        const headers = ["Trial Number", "Timestamp", "Difficulty Level", "Is Correct", "Reaction Time (ms)"];
        csvRows.push(headers.join(","));
        
        trialRecords.forEach(function(trial) {
            const row = [trial.trialNumber, trial.timestamp, trial.difficultyLevel, 
                        trial.isCorrect ? "1" : "0", trial.reactionTime];
            csvRows.push(row.join(","));
        });
        
        const csvContent = csvRows.join("\n");
        const BOM = '\uFEFF';
        const csvBase64 = btoa(unescape(encodeURIComponent(BOM + csvContent)));
        const fileName = "TEST_" + participantId + "_Session" + sessionNumber + "_Falling_Mid.csv";
        
        const templateParams = {
            participant_id: participantId,
            session_number: sessionNumber,
            experiment_type: "[TEST] Mid Falling Tone Discrimination (ABX)",
            start_time: window.experimentStartTime || 'N/A',
            completion_date: new Date().toLocaleString('zh-CN'),
            total_trials: trialRecords.length,
            total_reversals: NumberOfReversals || 0,
            jnd_value: "TEST - Data may be incomplete",
            accuracy: "TEST",
            mean_rt: "TEST",
            attachment_name: fileName,
            attachment_content: csvBase64,
            results_summary: "This is a TEST email to verify email functionality."
        };
        
        const serviceId = (typeof EMAIL_CONFIG !== 'undefined' && EMAIL_CONFIG.serviceId) || 'service_exe9d5a';
        const templateId = (typeof EMAIL_CONFIG !== 'undefined' && EMAIL_CONFIG.templateId) || 'template_4c3g3ss';
        
        emailjs.send(serviceId, templateId, templateParams)
            .then(function(response) {
                logDebug("Test email sent successfully! Status: " + response.status);
                alert('測試郵件發送成功！\n\n注意：這只是測試，實驗完成後仍會自動發送正式結果。');
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            })
            .catch(function(error) {
                logDebug("Test email failed: " + error);
                alert('測試郵件發送失敗：' + error.text);
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            });
        
    } catch (error) {
        logDebug("Error during email test: " + error);
        alert('郵件發送過程中出錯：' + error);
        testBtn.disabled = false;
        testBtn.textContent = originalText;
    }
}

function exportToCSV() {
    // 获取 ParticipantID 和 Session
    const urlParams = new URLSearchParams(window.location.search);
    const participantId = urlParams.get('participantId') || localStorage.getItem('participantId') || 'N/A';
    const sessionNumber = urlParams.get('sessionNumber') || localStorage.getItem('sessionNumber') || 'N/A';
    
    const csvRows = [];
    
    // 添加被试信息
    csvRows.push("Participant ID: " + participantId);
    csvRows.push("Session Number: " + sessionNumber);
    csvRows.push("");
    
    const headers = [
        "Trial Number", 
        "Timestamp", 
        "Difficulty Level", 
        "Modulation Window (%)",
        "Modulation Window (ms)",
        "Modulation Rate (semitones/s)",
        "Slope (semitones/ms)",
        "Standard Position",
        "User Response", 
        "Correct Response", 
        "Is Correct", 
        "Reaction Time (ms)", 
        "Is Reversal",
        "Step Direction"
    ];
    
    csvRows.push(headers.join(","));
    
    trialRecords.forEach(function(trial) {
        const row = [
            trial.trialNumber,
            trial.timestamp,
            trial.difficultyLevel,
            trial.modulationWindowPercent,
            trial.modulationWindowDuration,
            trial.modulationRate,
            trial.slope,
            trial.standardPosition,
            trial.userResponse,
            trial.correctResponse,
            trial.isCorrect ? "1" : "0",
            trial.reactionTime,
            trial.isReversal ? "1" : "0",
            trial.stepDirection
        ];
        csvRows.push(row.join(","));
    });
    
    csvRows.push("\nRESULTS SUMMARY - JUST NOTICEABLE DIFFERENCE (JND)");
    csvRows.push("\nJND Metrics");
    csvRows.push("Parameter,Value,Unit,Description");
    
    const hasData = NumberOfReversals >= MINIMUMREVERSALS;
    
    csvRows.push("JND Absolute Difference," + 
        (hasData ? jndAbsoluteDifference.toFixed(2) : "N/A") + ",ms,Detectable difference from standard (smaller = better)");
    
    csvRows.push("JND Percentage Difference," + 
        (hasData ? jndPercentDifference.toFixed(2) : "N/A") + ",%,Percentage difference from standard (smaller = better)");
    
    csvRows.push("JND Ratio (Threshold/Standard)," + 
        (hasData ? jndRatio.toFixed(4) : "N/A") + ",ratio,Threshold modulation window / Standard window");
    
    csvRows.push("Weber's Ratio," + 
        (hasData ? webersRatio.toFixed(4) : "N/A") + ",ratio,ΔI / I (smaller = better sensitivity)");
    
    csvRows.push("\nThreshold Parameters");
    csvRows.push("Parameter,Value,Unit");
    
    csvRows.push("Standard Modulation Window," + STANDARD_WINDOW + ",ms");
    
    csvRows.push("Threshold Modulation Window," + 
        (hasData ? thresholdWindowDuration.toFixed(2) : "N/A") + ",ms");
    
    csvRows.push("Threshold Window Percentage," + 
        (hasData ? thresholdWindowPercent.toFixed(2) : "N/A") + ",%");
    
    csvRows.push("Threshold Modulation Rate," + 
        (hasData ? thresholdModulationRate.toFixed(4) : "N/A") + ",semitones/s");
    
    csvRows.push("Threshold Slope," + 
        (hasData ? thresholdSlope.toFixed(6) : "N/A") + ",semitones/ms");
    
    csvRows.push("Average Difficulty Level," + 
        (hasData ? sentAverage.toFixed(2) : "N/A") + ",level (1-10)");
    
    csvRows.push("Difficulty Level SD," + 
        (hasData ? sentStdev.toFixed(2) : "N/A") + ",level");
    
    const rtStats = calculateReactionTimeStats();
    csvRows.push("\nReaction Time Statistics");
    csvRows.push("Mean,Median,Standard Deviation");
    csvRows.push(rtStats.mean + "," + rtStats.median + "," + rtStats.sd);
    
    const accuracyStats = calculateAccuracyStats();
    csvRows.push("\nAccuracy Statistics");
    csvRows.push("Correct Responses,Total Responses,Percentage");
    csvRows.push(accuracyStats.correct + "," + accuracyStats.total + "," + accuracyStats.percentage + "%");
    
    csvRows.push("\nExperiment Parameters");
    csvRows.push("Parameter,Value");
    csvRows.push("Paradigm,ABX");
    csvRows.push("Adaptive Rule,2-down-1-up");
    csvRows.push("Maximum Repeat Count," + MAX_REPEAT_COUNT);
    csvRows.push("Stimulus Type,Dynamic Pitch (Falling Tone)");
    csvRows.push("Total Stimulus Duration," + STIMULUS_DURATION + " ms");
    csvRows.push("Standard Modulation Window," + STANDARD_WINDOW + " ms");
    csvRows.push("Pitch Fall Amount," + PITCH_FALL_SEMITONES + " semitone(s)");
    csvRows.push("Max Reversals," + MAXREVERSALS);
    csvRows.push("Min Reversals for Calculation," + MINIMUMREVERSALS);
    csvRows.push("Max Iterations," + MAXITERATIONS);
    
    csvRows.push("\nDifficulty Level Mapping");
    csvRows.push("Level,Modulation Window (%),Modulation Window (ms),Difference from Standard (ms),Modulation Rate (semitones/s),Slope (semitones/ms)");
    for (let level = 1; level <= 10; level++) {
        const windowPercent = MODULATION_WINDOWS[level];
        const windowDuration = getModulationWindowDuration(level);
        const diffFromStandard = STANDARD_WINDOW - windowDuration;
        const rate = getModulationRate(level);
        const slope = getModulationSlope(level);
        csvRows.push(level + "," + windowPercent + "," + windowDuration.toFixed(2) + "," + 
                     diffFromStandard.toFixed(2) + "," + rate.toFixed(4) + "," + slope.toFixed(6));
    }
    
    const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "mid_falling_pitch_JND_ABX_data_" + timestamp + ".csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function window_onload() {
    window.name = "EXP";
    NumberOfReversals = 0;
    numberOfIterations = 0;
    CorrectResponses = 0;
    Direction = DECREASING;
    currentLevel = 5;
    isTestComplete = false;
    Reversals = [];
    trialRecords = [];
    isReplayTrial = false;
    currentRepeatCount = 0;
    emailSent = false;
    
    jndAbsoluteDifference = 0;
    jndRatio = 0;
    jndPercentDifference = 0;
    thresholdWindowDuration = 0;
    thresholdWindowPercent = 0;
    thresholdModulationRate = 0;
    thresholdSlope = 0;
    webersRatio = 0;

    document.getElementById('text1').value = "準備完畢後請點擊\"開始實驗\"";
    document.getElementById('smile').src = "Media/null.gif";
    document.getElementById('start').disabled = false;
    document.getElementById('viewResult').disabled = true;
    document.getElementById('promptText').style.visibility = 'hidden';
    document.getElementById('experimentContainer').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';
    
    updateProgressBar(0);
    
    logDebug("Page reset complete");
}

window.onload = function() {
    window_onload();
    
    var allAudios = document.querySelectorAll('audio');
    logDebug("Preloading " + allAudios.length + " audio files");
    
    allAudios.forEach(function(audio) {
        audio.load();
    });
    
    document.getElementById('text1').value = "請點擊\"開始實驗\"";
    
    window.onerror = function(message, source, lineno, colno, error) {
        logDebug("Global error: " + message + " at " + source + ":" + lineno);
        return false;
    };
    
    document.getElementById('showDebug').checked = true;
    toggleDebug();
    
    // 显示实验进度
    displayExperimentProgress();
};

/**
 * 显示实验进度信息
 */
function displayExperimentProgress() {
    const experimentSequence = JSON.parse(localStorage.getItem('experimentSequence') || '[]');
    const currentIndex = parseInt(localStorage.getItem('currentExperimentIndex') || '0');
    
    if (experimentSequence.length > 0) {
        const totalExperiments = experimentSequence.length;
        const currentNumber = currentIndex + 1;
        
        const progressElement = document.getElementById('experimentProgress');
        const progressText = document.getElementById('progressText');
        
        if (progressElement && progressText) {
            progressText.textContent = `${currentNumber}/${totalExperiments}`;
            progressElement.style.display = 'inline-block';
            
            logDebug(`Displaying experiment progress: ${currentNumber}/${totalExperiments}`);
        }
    }
}
</script>
</body>
</html>