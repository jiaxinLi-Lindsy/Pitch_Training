<!DOCTYPE html>
<html>
<head>
    <title>POLYU-Peng's Lab: Pitch Sensitivity Training</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f8f8;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            width: 100%;
        }
        .training-info {
            font-size: 16px;
            color: #555;
            margin-top: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        .button-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            width: 100%;
        }
        .prompt-text {
            text-align: center;
            font-size: 20px;
            margin-bottom: 25px;
            margin-top: 30px;
            font-weight: bold;
        }
        .response-button {
            width: 160px; /* 更大的正方形按钮 */
            height: 160px; /* 更大的正方形按钮 */
            font-size: 26px; /* 增大字体 */
            margin: 0 40px; /* 增加左右间距 */
            border-radius: 15px; /* 适当调整圆角 */
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* 添加阴影效果 */
            transition: all 0.2s ease; /* 添加过渡效果 */
        }
        .response-button:hover:enabled {
            transform: translateY(-3px); /* 悬停时轻微上浮 */
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .response-button:active:enabled {
            transform: translateY(1px); /* 点击时下沉 */
        }
        .control-button-container {
            display: flex;
            justify-content: center;
            gap: 30px; /* 使用gap属性控制间距 */
            margin: 30px 0;
            width: 100%;
        }
        .control-button {
            padding: 14px 28px; /* 更大的控制按钮 */
            font-size: 18px; /* 增大字体 */
            border-radius: 8px;
            border: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1); /* 添加阴影效果 */
            transition: all 0.2s ease; /* 添加过渡效果 */
        }
        .control-button:hover:enabled {
            background-color: #3e8e41;
            transform: translateY(-2px); /* 悬停时轻微上浮 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .control-button:active:enabled {
            transform: translateY(1px); /* 点击时下沉 */
        }
        .control-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .feedback {
            text-align: center;
            height: 100px;
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .status {
            width: 350px;
            height: 68px;
            text-align: center;
            font-size: 18px; /* 增大字体 */
            border: 1px solid #ddd;
            border-radius: 8px; /* 添加圆角 */
            margin: 0 auto;
            padding: 10px; /* 增加内边距 */
            background-color: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* 添加轻微阴影 */
        }
        .debug-info {
            font-size: 12px;
            color: #777;
            margin-top: 30px;
            text-align: left;
            display: none; /* Hide by default */
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px; /* 添加圆角 */
            padding: 15px;
            width: 100%;
        }
        /* Results container styles */
        .results-container {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f8ff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
        }
        .result-heading {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .result-table th, .result-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .result-table th {
            background-color: #3498db;
            color: white;
        }
        .result-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .result-interpretation {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .back-button {
            display: block;
            margin: 0 auto;
            padding: 14px 28px; /* 保持与控制按钮一致 */
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1); /* 添加阴影效果 */
            transition: all 0.2s ease; /* 添加过渡效果 */
        }
        .back-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px); /* 悬停时轻微上浮 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .back-button:active {
            transform: translateY(1px); /* 点击时下沉 */
        }
        .chart-container {
            height: 300px;
            margin: 20px 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        /* 调整辅助按钮区域 */
        .auxiliary-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 20px;
        }
        .auxiliary-buttons button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .auxiliary-buttons button:hover {
            background-color: #e0e0e0;
        }
        .diagnostic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .diagnostic-content {
            width: 80%;
            max-width: 700px;
            max-height: 80%;
            overflow-y: auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .diagnostic-heading {
            text-align: center;
            color: #e74c3c;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .diagnostic-close {
            float: right;
            font-size: 20px;
            cursor: pointer;
            color: #777;
        }
        .diagnostic-close:hover {
            color: #333;
        }
        .diagnostic-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .diagnostic-actions {
            text-align: center;
            margin-top: 20px;
        }
        .diagnostic-action-button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .retry-button {
            background-color: #3498db;
            color: white;
        }
        .retry-button:hover {
            background-color: #2980b9;
        }
        .continue-button {
            background-color: #2ecc71;
            color: white;
        }
        .continue-button:hover {
            background-color: #27ae60;
        }
        .diagnostic-file-check {
            margin: 20px 0;
        }
        .diagnostic-file-status {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .file-status-item {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 3px;
            background-color: #f8f8f8;
        }
        .file-found {
            color: #27ae60;
            border-left: 3px solid #27ae60;
        }
        .file-missing {
            color: #e74c3c;
            border-left: 3px solid #e74c3c;
        }
        .statistics-table {
            width: 100%;
            margin: 10px 0;
            border-collapse: collapse;
        }
        .statistics-table th, .statistics-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .statistics-table th {
            background-color: #f0f0f0;
        }
        .direction-stats-good {
            color: #27ae60;
        }
        .direction-stats-warning {
            color: #f39c12;
        }
        .direction-stats-bad {
            color: #e74c3c;
        }
        /* 响应式适配 */
        @media (max-width: 600px) {
            .response-button {
                width: 130px;
                height: 130px;
                font-size: 22px;
                margin: 0 20px;
            }
            .control-button {
                padding: 12px 20px;
            }
        }
        /* 添加打印按钮样式 */
        .print-button {
            padding: 14px 28px;
            margin: 20px auto;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            display: block;
        }
        .print-button:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .print-button:active {
            transform: translateY(1px);
        }
        /* 打印样式 */
        @media print {
            body {
                background-color: white;
                margin: 0;
                padding: 0;
            }
            .container {
                max-width: 100%;
                box-shadow: none;
                padding: 10px;
            }
            .back-button, .print-button, .auxiliary-buttons {
                display: none;
            }
            .results-container {
                display: block !important;
                box-shadow: none;
                background-color: white;
                padding: 0;
            }
            .chart-container {
                border: 1px solid #ddd;
                background-color: white;
            }
            .result-table th {
                background-color: #f0f0f0 !important;
                color: black !important;
            }
            .result-interpretation {
                background-color: white;
                border: 1px solid #ddd;
            }
            /* 强制显示背景色和图片 */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* 新增：进度条样式 */
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .progress-label {
            text-align: center;
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="Media/animation.gif" alt="Experiment animation">
            <div class="training-info">Low Register Discrimination (2AFC)</div>
        </div>

        <div id="experimentContainer">
            <div class="control-button-container">
                <input id="start" type="button" value="Start Experiment" onclick="start_onclick()" class="control-button">
                <input id="viewResult" type="button" value="View Results" onclick="view_onclick()" class="control-button" disabled>
            </div>

            <div class="prompt-text" id="promptText">
                The second tone is...
            </div>
            
            <div class="button-container">
                <input id="higherBtn" type="button" value="Higher" onclick="processAnswer(1)" disabled 
                    class="response-button" style="background:#FF6666;">
                <input id="lowerBtn" type="button" value="Lower" onclick="processAnswer(-1)" disabled 
                    class="response-button" style="background:#FF6666;">
            </div>

            <div class="feedback">
                <img id="smile" src="Media/null.gif" width="100" height="84" alt="Feedback"> <!-- 增大图片 -->
            </div>
            
            <div class="button-container">
                <input id="text1" class="status" readonly>
            </div>
            
            <!-- 新增：进度条 -->
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-label" id="progressLabel">Progress: 0%</div>
            
            <div class="debug-info" id="debugInfo">
                Debug information will be displayed here
            </div>
            
            <div class="auxiliary-buttons">
                <label><input type="checkbox" id="showDebug" onclick="toggleDebug()"> Show Debug Info</label>
                <button onclick="testAudio()">Test All Audio</button>
                <button onclick="showDiagnostics()">Diagnostics</button>
                <button onclick="exportToCSV()">Export Data (CSV)</button>
            </div>
        </div>
        
        <!-- Embedded Results Display Area -->
        <div id="resultsContainer" class="results-container">
            <h2 class="result-heading">Pitch Discrimination Test Results</h2>
            
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Test Direction</th>
                        <th>Threshold (semitones)</th>
                        <th>Std. Deviation</th>
                        <th>Assessment</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody">
                    <!-- Results will be populated by JavaScript -->
                </tbody>
            </table>
            
            <div class="result-interpretation" id="resultInterpretation">
                <!-- Interpretation will be populated by JavaScript -->
            </div>
            
            <!-- 新增：反应时间统计表格 -->
            <h3>Reaction Time Statistics</h3>
            <table class="result-table" id="rtStatsTable">
                <thead>
                    <tr>
                        <th>Direction</th>
                        <th>Mean RT (ms)</th>
                        <th>Median RT (ms)</th>
                        <th>RT Std. Deviation</th>
                    </tr>
                </thead>
                <tbody id="rtStatsTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
            
            <!-- 新增：正确率统计表格 -->
            <h3>Accuracy Statistics</h3>
            <table class="result-table" id="accuracyStatsTable">
                <thead>
                    <tr>
                        <th>Direction</th>
                        <th>Correct Responses</th>
                        <th>Total Responses</th>
                        <th>Accuracy</th>
                    </tr>
                </thead>
                <tbody id="accuracyStatsTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
            
            <div class="chart-container" id="resultChart">
                <!-- Chart will be generated by JavaScript -->
            </div>
            
            <!-- 添加打印按钮 -->
            <button class="print-button" onclick="printResults()">Print Results</button>
            
            <button class="back-button" onclick="backToExperiment()">Back to Experiment</button>
        </div>
        
        <!-- Diagnostic Overlay -->
        <div class="diagnostic-overlay" id="diagnosticOverlay">
            <div class="diagnostic-content">
                <span class="diagnostic-close" onclick="closeDiagnostics()">&times;</span>
                <h2 class="diagnostic-heading">Experiment Diagnostics</h2>
                
                <div class="diagnostic-section">
                    <h3>Test Status</h3>
                    <table class="statistics-table">
                        <tr>
                            <th>Direction</th>
                            <th>Trials</th>
                            <th>Reversals</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td>Higher Direction</td>
                            <td id="higherTrials">0</td>
                            <td id="higherReversals">0</td>
                            <td id="higherStatus">Not started</td>
                        </tr>
                        <tr>
                            <td>Lower Direction</td>
                            <td id="lowerTrials">0</td>
                            <td id="lowerReversals">0</td>
                            <td id="lowerStatus">Not started</td>
                        </tr>
                    </table>
                </div>
                
                <div class="diagnostic-section">
                    <h3>Audio Files Check</h3>
                    <p>Verifying necessary audio files:</p>
                    <div id="audioFileStatus" class="diagnostic-file-status">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <div class="diagnostic-section">
                    <h3>Reversal History</h3>
                    <div id="reversalHistory">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <div class="diagnostic-section">
                    <h3>Recommendations</h3>
                    <div id="diagnosticRecommendations">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <div class="diagnostic-actions">
                    <button class="diagnostic-action-button retry-button" onclick="retryIncompleteDirection()">Retry Incomplete Direction</button>
                    <button class="diagnostic-action-button continue-button" onclick="closeDiagnostics()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Correct naming for base standard tone - CHANGED TO LOW REGISTER -->
    <audio id="low_level_standard" src="Media/low_level_standard.wav" preload="auto"></audio>

    <!-- Higher stimuli - using naming convention - CHANGED TO LOW REGISTER -->
    <audio id="low_level_1_h" src="Media/low_level_1_h.wav" preload="auto"></audio>
    <audio id="low_level_2_h" src="Media/low_level_2_h.wav" preload="auto"></audio>
    <audio id="low_level_3_h" src="Media/low_level_3_h.wav" preload="auto"></audio>
    <audio id="low_level_4_h" src="Media/low_level_4_h.wav" preload="auto"></audio>
    <audio id="low_level_5_h" src="Media/low_level_5_h.wav" preload="auto"></audio>
    <audio id="low_level_6_h" src="Media/low_level_6_h.wav" preload="auto"></audio>
    <audio id="low_level_7_h" src="Media/low_level_7_h.wav" preload="auto"></audio>
    <audio id="low_level_8_h" src="Media/low_level_8_h.wav" preload="auto"></audio>
    <audio id="low_level_9_h" src="Media/low_level_9_h.wav" preload="auto"></audio>

    <!-- Lower stimuli - using naming convention - CHANGED TO LOW REGISTER -->
    <audio id="low_level_1_l" src="Media/low_level_1_l.wav" preload="auto"></audio>
    <audio id="low_level_2_l" src="Media/low_level_2_l.wav" preload="auto"></audio>
    <audio id="low_level_3_l" src="Media/low_level_3_l.wav" preload="auto"></audio>
    <audio id="low_level_4_l" src="Media/low_level_4_l.wav" preload="auto"></audio>
    <audio id="low_level_5_l" src="Media/low_level_5_l.wav" preload="auto"></audio>
    <audio id="low_level_6_l" src="Media/low_level_6_l.wav" preload="auto"></audio>
    <audio id="low_level_7_l" src="Media/low_level_7_l.wav" preload="auto"></audio>
    <audio id="low_level_8_l" src="Media/low_level_8_l.wav" preload="auto"></audio>
    <audio id="low_level_9_l" src="Media/low_level_9_l.wav" preload="auto"></audio>

<script>
// Adaptive threshold experiment constants
const MAXREVERSALS = 12;      // Maximum number of reversals, one condition to end experiment
const MAXITERATIONS = 70;     // Maximum iterations, another condition to end experiment
const LOWERLIMIT = 1;         // Difficulty lower bound (maximum difference, easiest)
const DECREASING = -1;        // Direction of increasing difficulty (decreasing difference)
const INCREASING = 1;         // Direction of decreasing difficulty (increasing difference)
const MINIMUMREVERSALS = 6;   // Minimum number of reversals for threshold calculation
const FORCEBALANCETHRESHOLD = 5; // Max difference in trials between directions before forcing balance

// Experiment state variables
var CorrectDirection;         // Correct answer for current trial: 1=higher, -1=lower
var CorrectResponses = [0, 0]; // Count of consecutive correct responses [higher direction, lower direction]
var Direction = [DECREASING, DECREASING]; // Difficulty adjustment direction [higher dir, lower dir]
var Reversals = [[], []];     // Difficulty levels when reversals occur [higher dir reversals, lower dir reversals]
var NumberOfReversals = [0, 0]; // Total reversal count [higher dir, lower dir]
var currentLevel = [5, 5];    // Current difficulty level [higher dir, lower dir], start at medium difficulty 5
var numberOfIterations = 0;   // Current iteration count
var sentAverage = [0.0, 0.0]; // Calculated thresholds [higher dir, lower dir]
var sentStdev = [0.0, 0.0];   // Threshold standard deviations [higher dir, lower dir]
var currentStimDirection;     // Current test direction to be randomized each trial
var isTestComplete = [false, false]; // Test completion status [higher dir, lower dir]
var audioUnlocked = false;    // Flag if audio is unlocked
var trialsPerDirection = [0, 0]; // Count of trials for each direction
var forceDirection = null;    // Used to force a specific direction for balance or retry
var directionHistory = [];    // Track the history of directions tested
var allFilesPresent = true;   // Track if all audio files are present

// 新增：详细记录每个试验的数据对象
var trialRecords = [];

// 新增：刺激结束时间，用于计算反应时间
var stimulusEndTime = 0;

// 新增：打印结果页面
function printResults() {
    window.print();
}

// Simple logging function, output to console and debug area
function logDebug(message) {
    console.log(message);
    var debugArea = document.getElementById('debugInfo');
    var now = new Date();
    var timeStr = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + '.' + now.getMilliseconds();
    debugArea.innerHTML += '<p>[' + timeStr + '] ' + message + '</p>';
    
    // Keep scrolled to bottom
    debugArea.scrollTop = debugArea.scrollHeight;
}

// Toggle debug information display
function toggleDebug() {
    var debugArea = document.getElementById('debugInfo');
    var checkbox = document.getElementById('showDebug');
    debugArea.style.display = checkbox.checked ? 'block' : 'none';
}

// Show diagnostics overlay
function showDiagnostics() {
    updateDiagnostics();
    document.getElementById('diagnosticOverlay').style.display = 'flex';
}

// Close diagnostics overlay
function closeDiagnostics() {
    document.getElementById('diagnosticOverlay').style.display = 'none';
}

// Update diagnostics information
function updateDiagnostics() {
    // Update test statistics
    document.getElementById('higherTrials').innerText = trialsPerDirection[0];
    document.getElementById('lowerTrials').innerText = trialsPerDirection[1];
    document.getElementById('higherReversals').innerText = NumberOfReversals[0];
    document.getElementById('lowerReversals').innerText = NumberOfReversals[1];
    
    // Determine status for each direction
    let higherStatus = getDirectionStatus(0);
    let lowerStatus = getDirectionStatus(1);
    
    document.getElementById('higherStatus').innerText = higherStatus.text;
    document.getElementById('higherStatus').className = `direction-stats-${higherStatus.class}`;
    document.getElementById('lowerStatus').innerText = lowerStatus.text;
    document.getElementById('lowerStatus').className = `direction-stats-${lowerStatus.class}`;
    
    // Check audio files
    checkAudioFiles();
    
    // Show reversal history
    let reversalHistoryHtml = '<h4>Higher Direction</h4>';
    if (Reversals[0].length === 0) {
        reversalHistoryHtml += '<p>No reversals recorded yet</p>';
    } else {
        reversalHistoryHtml += '<p>Reversals at difficulty levels: ' + Reversals[0].join(', ') + '</p>';
    }
    
    reversalHistoryHtml += '<h4>Lower Direction</h4>';
    if (Reversals[1].length === 0) {
        reversalHistoryHtml += '<p>No reversals recorded yet</p>';
    } else {
        reversalHistoryHtml += '<p>Reversals at difficulty levels: ' + Reversals[1].join(', ') + '</p>';
    }
    
    document.getElementById('reversalHistory').innerHTML = reversalHistoryHtml;
    
    // Generate recommendations
    generateDiagnosticRecommendations();
}

// Get direction status for diagnostics
function getDirectionStatus(dirIndex) {
    if (isTestComplete[dirIndex]) {
        return { text: "Complete", class: "good" };
    }
    
    if (NumberOfReversals[dirIndex] < 1) {
        return { text: "Not enough data", class: "bad" };
    }
    
    if (NumberOfReversals[dirIndex] < MINIMUMREVERSALS) {
        return { text: "Incomplete (" + NumberOfReversals[dirIndex] + "/" + MINIMUMREVERSALS + " reversals)", class: "warning" };
    }
    
    return { text: "In progress", class: "good" };
}

// Check if all audio files are present
function checkAudioFiles() {
    const requiredFiles = [
        "low_level_standard",
        "low_level_1_h", "low_level_2_h", "low_level_3_h", "low_level_4_h", "low_level_5_h", 
        "low_level_6_h", "low_level_7_h", "low_level_8_h", "low_level_9_h",
        "low_level_1_l", "low_level_2_l", "low_level_3_l", "low_level_4_l", "low_level_5_l", 
        "low_level_6_l", "low_level_7_l", "low_level_8_l", "low_level_9_l"
    ];
    
    let statusHtml = '';
    allFilesPresent = true;
    
    requiredFiles.forEach(function(fileId) {
        const audioElement = document.getElementById(fileId);
        const fileFound = audioElement !== null;
        
        if (!fileFound) {
            allFilesPresent = false;
        }
        
        statusHtml += `<div class="file-status-item ${fileFound ? 'file-found' : 'file-missing'}">${fileId}: ${fileFound ? 'Found' : 'Missing'}</div>`;
    });
    
    document.getElementById('audioFileStatus').innerHTML = statusHtml;
}

// Generate diagnostic recommendations
function generateDiagnosticRecommendations() {
    let recommendations = '';
    let hasIssues = false;
    
    if (!allFilesPresent) {
        recommendations += '<p><strong>Critical Issue:</strong> Some required audio files are missing. Please ensure all files are properly loaded.</p>';
        hasIssues = true;
    }
    
    // Check for direction imbalance
    const directionDifference = Math.abs(trialsPerDirection[0] - trialsPerDirection[1]);
    if (directionDifference > 10 && !isTestComplete[0] && !isTestComplete[1]) {
        recommendations += '<p><strong>Warning:</strong> Trial count is imbalanced between higher and lower directions. ' +
            'Consider restarting experiment.</p>';
        hasIssues = true;
    }
    
    // Check for insufficient reversals in either direction
    for (let i = 0; i < 2; i++) {
        if (trialsPerDirection[i] >= MAXITERATIONS/2 && NumberOfReversals[i] < MINIMUMREVERSALS) {
            recommendations += '<p><strong>Issue:</strong> ' + (i === 0 ? 'Higher' : 'Lower') + 
                ' direction reached maximum trials but has insufficient reversals. This might indicate audio file issues or participant response patterns.</p>';
            hasIssues = true;
        }
    }
    
    // Check for late experiment abortion
    if (numberOfIterations > 10 && (trialsPerDirection[0] === 0 || trialsPerDirection[1] === 0)) {
        recommendations += '<p><strong>Warning:</strong> One direction has not been tested at all. Algorithm may be malfunctioning.</p>';
        hasIssues = true;
    }
    
    if (!hasIssues) {
        recommendations += '<p><strong>Good:</strong> No major issues detected with the experiment setup.</p>';
        
        // Add general status
        if (isTestComplete[0] && isTestComplete[1]) {
            recommendations += '<p>Both test directions are complete.</p>';
        } else if (isTestComplete[0]) {
            recommendations += '<p>Higher direction test is complete. Lower direction test still needs more data.</p>';
        } else if (isTestComplete[1]) {
            recommendations += '<p>Lower direction test is complete. Higher direction test still needs more data.</p>';
        } else {
            recommendations += '<p>Both test directions are still in progress.</p>';
        }
    }
    
    document.getElementById('diagnosticRecommendations').innerHTML = recommendations;
}

// Retry the incomplete direction
function retryIncompleteDirection() {
    // Determine which direction to retry
    let retryDirection = null;
    
    if (isTestComplete[0] && !isTestComplete[1]) {
        retryDirection = 1; // Retry lower direction
    } else if (!isTestComplete[0] && isTestComplete[1]) {
        retryDirection = 0; // Retry higher direction
    } else if (!isTestComplete[0] && !isTestComplete[1]) {
        // If neither is complete, retry the one with fewer reversals
        retryDirection = (NumberOfReversals[0] < NumberOfReversals[1]) ? 0 : 1;
    } else {
        // Both are complete, nothing to retry
        alert("Both directions are already complete.");
        return;
    }
    
    // Reset the selected direction
    resetDirection(retryDirection);
    
    // Force the next several trials to use this direction
    forceDirection = retryDirection;
    
    // Close diagnostics and continue experiment
    closeDiagnostics();
    
    if (document.getElementById('start').disabled) {
        // Experiment is already running, just continue
        document.getElementById('text1').value = "Retrying " + (retryDirection === 0 ? "higher" : "lower") + " direction...";
        beginIteration();
    } else {
        // Start the experiment again
        start_onclick();
    }
}

// Reset a specific direction
function resetDirection(dirIndex) {
    NumberOfReversals[dirIndex] = 0;
    CorrectResponses[dirIndex] = 0;
    Direction[dirIndex] = DECREASING;
    currentLevel[dirIndex] = 5;
    isTestComplete[dirIndex] = false;
    Reversals[dirIndex] = [];
    trialsPerDirection[dirIndex] = 0;
    
    // 新增：从trialRecords中移除该方向的记录
    trialRecords = trialRecords.filter(record => 
        record.direction !== (dirIndex === 0 ? "Higher" : "Lower")
    );
    
    logDebug((dirIndex === 0 ? "Higher" : "Lower") + " direction reset");
    
    // 更新进度条
    updateProgressBar();
}

// Test all audio files
function testAudio() {
    logDebug("Starting to test all audio files...");
    var audios = document.querySelectorAll('audio');
    
    // Unlock audio context
    if (!audioUnlocked) {
        unlockAudioContext();
    }
    
    var index = 0;
    function playNext() {
        if (index >= audios.length) {
            logDebug("All audio testing complete!");
            return;
        }
        
        var audio = audios[index];
        logDebug("Testing audio #" + (index + 1) + ": " + audio.id);
        
        // Reset and play
        audio.currentTime = 0;
        
        // Use promise to handle playback
        var playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.then(function() {
                logDebug(audio.id + " played successfully");
                
                // Set ended event to play next
                audio.onended = function() {
                    logDebug(audio.id + " playback ended");
                    index++;
                    setTimeout(playNext, 500);
                };
            }).catch(function(error) {
                logDebug("Failed to play " + audio.id + ": " + error);
                index++;
                setTimeout(playNext, 500);
            });
        }
    }
    
    playNext();
}

// Unlock audio context
function unlockAudioContext() {
    logDebug("Attempting to unlock audio context...");
    
    // Create brief silent audio
    var silentAudio = new Audio();
    silentAudio.src = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA";
    
    // Try playing silent audio
    var promise = silentAudio.play();
    if (promise !== undefined) {
        promise.then(function() {
            logDebug("Audio context unlocked successfully");
            silentAudio.remove();
            audioUnlocked = true;
        }).catch(function(error) {
            logDebug("Failed to unlock audio context: " + error);
        });
    }
    
    // Touch all audio elements
    var allAudios = document.querySelectorAll('audio');
    for (var i = 0; i < allAudios.length; i++) {
        var audio = allAudios[i];
        audio.load();
    }
    
    logDebug("Preloaded " + allAudios.length + " audio files");
}

// Reset page, prepare next iteration or end experiment
function resetPage() {
    numberOfIterations++;
    document.getElementById('higherBtn').disabled = true;
    document.getElementById('lowerBtn').disabled = true;
    document.getElementById('higherBtn').style.background = "#FF6666";
    document.getElementById('lowerBtn').style.background = "#FF6666";
    document.getElementById('promptText').style.visibility = 'hidden';
    
    // Check if both test directions are complete
    if (isTestComplete[0] && isTestComplete[1]) {
        document.getElementById('start').disabled = false;
        document.getElementById('viewResult').disabled = false;
        document.getElementById('text1').value = "Experiment complete! Click 'View Results' to see your threshold.";
        return;
    }
    
    // Check if current direction has reached completion criteria
    if ((trialsPerDirection[currentStimDirection] >= MAXITERATIONS/2) || 
        (NumberOfReversals[currentStimDirection] >= MAXREVERSALS)) {
        
        // Check if we have enough reversals before marking as complete
        if (NumberOfReversals[currentStimDirection] >= MINIMUMREVERSALS) {
            calculateResults(currentStimDirection);
            isTestComplete[currentStimDirection] = true;
        } else {
            // Not enough reversals, ask user what to do
            logDebug(
                (currentStimDirection === 0 ? "Higher" : "Lower") + 
                " direction reached max iterations but has only " + 
                NumberOfReversals[currentStimDirection] + "/" + MINIMUMREVERSALS + 
                " reversals. Showing diagnostics."
            );
            
            document.getElementById('text1').value = 
                (currentStimDirection === 0 ? "Higher" : "Lower") + 
                " direction has insufficient data. Check diagnostics.";
            
            setTimeout(function() {
                showDiagnostics();
            }, 500);
            return;
        }
        
        // Update progress bar
        updateProgressBar();
        
        // If other direction not complete, continue with mixed trials
        if (!isTestComplete[0] || !isTestComplete[1]) {
            document.getElementById('text1').value = "Continuing experiment...";
            setTimeout(function() {
                beginIteration();
            }, 2000);
        } else {
            document.getElementById('start').disabled = false;
            document.getElementById('viewResult').disabled = false;
            document.getElementById('text1').value = "Experiment complete! Click 'View Results' to see your threshold.";
            
            // 实验完成，进度条设为100%
            updateProgressBar(100);
        }
    } else {
        // 更新进度条
        updateProgressBar();
        beginIteration();
    }
}

// 新增：更新进度条函数
function updateProgressBar(forcePercent) {
    // 总进度分为两部分：高升方向和下降方向，各占50%
    // 如果直接提供了百分比值，则使用该值
    if (typeof forcePercent === 'number') {
        document.getElementById('progressBar').style.width = forcePercent + '%';
        document.getElementById('progressLabel').textContent = 'Progress: ' + forcePercent + '%';
        return;
    }
    
    // 计算高升方向完成百分比 (最大值为MAXREVERSALS或MAXITERATIONS/2)
    const higherDirMax = Math.max(MAXREVERSALS, MAXITERATIONS/2);
    const higherDirValue = isTestComplete[0] ? higherDirMax : Math.max(NumberOfReversals[0], trialsPerDirection[0]);
    const higherDirPercent = Math.min(50 * (higherDirValue / higherDirMax), 50);
    
    // 计算下降方向完成百分比
    const lowerDirMax = Math.max(MAXREVERSALS, MAXITERATIONS/2);
    const lowerDirValue = isTestComplete[1] ? lowerDirMax : Math.max(NumberOfReversals[1], trialsPerDirection[1]);
    const lowerDirPercent = Math.min(50 * (lowerDirValue / lowerDirMax), 50);
    
    // 合计总百分比
    const totalPercent = higherDirPercent + lowerDirPercent;
    
    // 更新进度条
    document.getElementById('progressBar').style.width = totalPercent + '%';
    document.getElementById('progressLabel').textContent = 'Progress: ' + Math.round(totalPercent) + '%';
}

// Calculate threshold results
function calculateResults(directionIndex) {
    let sum = 0.0, stddevsum = 0.0, average = 0.0, stdev = 0.0, counter = 0;
    
    // 修正：正确的半音差异映射（从最难的1/50到最简单的2半音）
    const semitoneMap = {
        1: 2.0,      // 最简单, 2 半音
        2: 1.0,      // 1 半音
        3: 1/2,      // 1/2 半音
        4: 1/6,      // 1/6 半音
        5: 1/8,      // 1/8 半音
        6: 1/12,     // 1/12 半音
        7: 1/15,     // 1/15 半音
        8: 1/20,     // 1/20 半音
        9: 1/50      // 最难, 1/50 半音
    };
    
    // Count valid reversals
    for (let i = 0; i < Reversals[directionIndex].length; i++) {
        if (Reversals[directionIndex][i] > 0) counter++;
    }
    
    if (counter < MINIMUMREVERSALS) {
        logDebug((directionIndex === 0 ? "Higher" : "Lower") + " direction test has insufficient data");
        alert((directionIndex === 0 ? "Higher" : "Lower") + " direction test has insufficient data. Please complete the test again.");
        return;
    }
    
    // Calculate average - use last 8 reversals (or available reversals)
    const startIndex = Math.max(0, NumberOfReversals[directionIndex] - 8);
    counter = 0;
    
    for (let i = startIndex; i < Reversals[directionIndex].length; i++) {
        const level = Reversals[directionIndex][i];
        if (level > 0) {
            const semitones = semitoneMap[level];
            if (semitones !== undefined) {
                sum += semitones;
                counter++;
            }
        }
    }
    
    if (counter > 0) {
        average = sum / counter;
        average = parseFloat(average.toFixed(4));
    }
    
    // Calculate standard deviation
    for (let i = startIndex; i < Reversals[directionIndex].length; i++) {
        const level = Reversals[directionIndex][i];
        if (level > 0) {
            const semitones = semitoneMap[level];
            if (semitones !== undefined) {
                stddevsum += Math.pow(semitones - average, 2);
            }
        }
    }
    
    if (counter > 1) {
        stdev = Math.sqrt(stddevsum / (counter - 1));
        stdev = parseFloat(stdev.toFixed(4));
    }
    
    sentAverage[directionIndex] = average;
    sentStdev[directionIndex] = stdev;
    
    logDebug((directionIndex === 0 ? "Higher" : "Lower") + " direction test complete! Threshold: " + average.toFixed(4) + " semitones");
    document.getElementById('text1').value = 
        (directionIndex === 0 ? "Higher" : "Lower") + " direction test complete! Threshold: " + average.toFixed(4) + " semitones";
}

// Begin an iteration
function beginIteration() {
    // If a direction is being forced, use that
    if (forceDirection !== null) {
        currentStimDirection = forceDirection;
        
        // Only force for a limited number of trials to prevent getting stuck
        if (trialsPerDirection[forceDirection] % 5 === 0) {
            logDebug("Releasing forced direction after 5 trials");
            forceDirection = null;
        }
    } 
    // If only one direction is still active, use that
    else if (isTestComplete[0]) {
        currentStimDirection = 1;
    } 
    else if (isTestComplete[1]) {
        currentStimDirection = 0;
    }
    // Balance directions if they're too imbalanced
    else if (Math.abs(trialsPerDirection[0] - trialsPerDirection[1]) > FORCEBALANCETHRESHOLD) {
        currentStimDirection = (trialsPerDirection[0] > trialsPerDirection[1]) ? 1 : 0;
        logDebug("Forcing balance: selecting " + (currentStimDirection === 0 ? "higher" : "lower") + " direction");
    }
    // Randomly select which direction to test if both directions are still active
    else {
        currentStimDirection = Math.random() < 0.5 ? 0 : 1;
    }
    
    // Track the direction history
    directionHistory.push(currentStimDirection);
    
    // Randomly decide if correct answer is higher or lower
    CorrectDirection = Math.random() < 0.5 ? 1 : -1;
    
    // Increment trial count for this direction
    trialsPerDirection[currentStimDirection]++;
    
    logDebug("Starting new iteration #" + numberOfIterations + 
             ", Direction: " + (currentStimDirection === 0 ? "Higher" : "Lower") + 
             ", Correct answer: " + (CorrectDirection === 1 ? "Higher" : "Lower") +
             ", Difficulty level: " + currentLevel[currentStimDirection]);
    
    setTimeout(function() {
        playAndChange();
    }, 1000);
}

// Play audio with manual sequence control
function playAndChange() {
    logDebug("Playing standard tone");
    
    // Get standard tone - CHANGED TO LOW REGISTER
    var baseSound = document.getElementById('low_level_standard');
    
    // Ensure base sound exists
    if (!baseSound) {
        logDebug("Error: Cannot find standard tone 'low_level_standard'");
        document.getElementById('text1').value = "Error: Cannot find audio file";
        return;
    }
    
    // Display current status
    document.getElementById('text1').value = "Listen to the first sound";
    
    // Ensure audio is reset
    baseSound.currentTime = 0;
    
    // Play with manual sequence control
    var playPromise = baseSound.play();
    
    if (playPromise !== undefined) {
        playPromise.then(function() {
            logDebug("Standard tone played successfully");
            
            // Callback when standard tone ends
            baseSound.onended = function() {
                logDebug("Standard tone playback ended, preparing comparison tone");
                
                // Show message after standard tone ends
                document.getElementById('text1').value = "Listen to the second sound";
                
                // Delay one second before playing second tone
                setTimeout(function() {
                    // Get comparison sound
                    var comparisonSound;
                    const level = currentLevel[currentStimDirection];
                    
                    logDebug("Current direction: " + (currentStimDirection === 0 ? "Higher" : "Lower") + 
                              ", Difficulty: " + level + 
                              ", Correct answer: " + (CorrectDirection === 1 ? "Higher" : "Lower"));
                    
                    // Correct stimulus selection logic - CHANGED TO LOW REGISTER
                    if (currentStimDirection === 0) { // Higher direction test
                        if (CorrectDirection === 1) { // Correct answer is "higher"
                            // Play higher stimulus at current difficulty
                            comparisonSound = document.getElementById("low_level_" + level + "_h");
                            logDebug("Selected higher stimulus: low_level_" + level + "_h");
                        } else { // Correct answer is "lower"
                            // Play standard tone
                            comparisonSound = document.getElementById('low_level_standard');
                            logDebug("Selected standard tone as comparison");
                        }
                    } else { // Lower direction test
                        if (CorrectDirection === 1) { // Correct answer is "higher"
                            // Play standard tone
                            comparisonSound = document.getElementById('low_level_standard');
                            logDebug("Selected standard tone as comparison");
                        } else { // Correct answer is "lower"
                            // Play lower stimulus at current difficulty
                            comparisonSound = document.getElementById("low_level_" + level + "_l");
                            logDebug("Selected lower stimulus: low_level_" + level + "_l");
                        }
                    }
                    
                    // Check if audio element exists
                    if (!comparisonSound) {
                        logDebug("Error: Cannot find comparison tone element!");
                        document.getElementById('text1').value = "Error: Cannot find audio file";
                        
                        // Show diagnostics if file is missing
                        setTimeout(function() {
                            showDiagnostics();
                        }, 1000);
                        return;
                    }
                    
                    logDebug("Playing comparison tone: " + comparisonSound.id);
                    
                    // Ensure audio is reset
                    comparisonSound.currentTime = 0;
                    
                    // Play comparison tone
                    var comparisonPromise = comparisonSound.play();
                    
                    if (comparisonPromise !== undefined) {
                        comparisonPromise.then(function() {
                            logDebug("Comparison tone played successfully");
                            
                            // Callback when comparison tone ends
                            comparisonSound.onended = function() {
                                logDebug("Comparison tone playback ended, enabling response buttons");
                                
                                // 新增：记录刺激结束时间，用于计算反应时间
                                stimulusEndTime = performance.now();
                                
                                // Update status and show prompt
                                document.getElementById('text1').value = "Make your selection";
                                document.getElementById('promptText').style.visibility = 'visible';
                                
                                // Enable response buttons after playback ends
                                document.getElementById('higherBtn').disabled = false;
                                document.getElementById('lowerBtn').disabled = false;
                                document.getElementById('higherBtn').style.background = "#66CCFF";
                                document.getElementById('lowerBtn').style.background = "#66CCFF";
                            };
                        }).catch(function(error) {
                            logDebug("Failed to play comparison tone: " + error);
                            document.getElementById('text1').value = "Audio playback error, please refresh the page";
                            
                            // Show diagnostics if playback fails
                            setTimeout(function() {
                                showDiagnostics();
                            }, 1000);
                        });
                    }
                }, 1000); // Gap between two stimuli
            };
        }).catch(function(error) {
            logDebug("Failed to play standard tone: " + error);
            document.getElementById('text1').value = "Audio playback error, please refresh the page";
            
            // Show diagnostics if playback fails
            setTimeout(function() {
                showDiagnostics();
            }, 1000);
        });
    }
}

// Start button click event
function start_onclick() {
    logDebug("Starting experiment");
    
    // First unlock audio context
    if (!audioUnlocked) {
        unlockAudioContext();
    }
    
    // Verify audio files before starting
    checkAudioFiles();
    if (!allFilesPresent) {
        logDebug("Cannot start experiment: Some audio files are missing");
        document.getElementById('text1').value = "Error: Some audio files are missing";
        showDiagnostics();
        return;
    }
    
    // Continue with normal start sequence
    window_onload();
    document.getElementById('text1').value = "Starting experiment...";
    
    // 重置进度条
    updateProgressBar(0);
    
    // Slight delay before beginning experiment
    setTimeout(function() {
        beginIteration();
        document.getElementById('start').disabled = true;
        document.getElementById('viewResult').disabled = true;
        document.getElementById('smile').src = "Media/null.gif";
        document.getElementById('promptText').style.visibility = 'hidden';
    }, 1000);
}

// Record a reversal
function gotReversal(dirIndex) {
    NumberOfReversals[dirIndex]++;
    Reversals[dirIndex][NumberOfReversals[dirIndex] - 1] = currentLevel[dirIndex];
    Direction[dirIndex] = -Direction[dirIndex]; // Change direction
    logDebug("Recorded reversal #" + NumberOfReversals[dirIndex] + " at difficulty " + currentLevel[dirIndex]);
}

// 修正：辅助函数，将难度级别映射为半音值
function mapLevelToSemitone(level) {
    const semitoneMap = {
        1: 2.0,      // 最简单, 2 半音
        2: 1.0,      // 1 半音
        3: 1/2,      // 1/2 半音
        4: 1/6,      // 1/6 半音
        5: 1/8,      // 1/8 半音
        6: 1/12,     // 1/12 半音
        7: 1/15,     // 1/15 半音
        8: 1/20,     // 1/20 半音
        9: 1/50      // 最难, 1/50 半音
    };
    return semitoneMap[level] || 0;
}

// Process user response
function processAnswer(Response) {
    // 新增：计算反应时间
    const reactionEndTime = performance.now();
    const reactionTime = reactionEndTime - stimulusEndTime;
    
    // Response: 1=higher, -1=lower
    logDebug("User answered: " + (Response === 1 ? "Higher" : "Lower") + ", Correct answer: " + (CorrectDirection === 1 ? "Higher" : "Lower"));
    
    document.getElementById('higherBtn').disabled = true;
    document.getElementById('lowerBtn').disabled = true;
    document.getElementById('promptText').style.visibility = 'hidden';
    
    // 新增：判断是否正确
    const isCorrect = (Response === CorrectDirection);
    
    // 新增：记录本次试验的详细数据
    const trialInfo = {
        trialNumber: numberOfIterations,
        timestamp: new Date().toISOString(),
        direction: currentStimDirection === 0 ? "Higher" : "Lower",
        difficultyLevel: currentLevel[currentStimDirection],
        semitoneValue: mapLevelToSemitone(currentLevel[currentStimDirection]),
        userResponse: Response === 1 ? "Higher" : "Lower",
        correctResponse: CorrectDirection === 1 ? "Higher" : "Lower",
        isCorrect: isCorrect,
        reactionTime: reactionTime.toFixed(0),
        isReversal: false, // 默认值，后面会更新
        stepDirection: Direction[currentStimDirection] === DECREASING ? "Increasing Difficulty" : "Decreasing Difficulty"
    };
    
    // 添加到试验记录数组
    trialRecords.push(trialInfo);
    
    if (isCorrect) { // Correct answer
        logDebug("Correct answer");
        document.getElementById('smile').src = "Media/smiley.png";
        document.getElementById('text1').value = "Correct!";
        CorrectResponses[currentStimDirection]++;
        
        if (CorrectResponses[currentStimDirection] == 2) { // Two correct answers in a row
            logDebug("Two correct answers in a row");
            CorrectResponses[currentStimDirection] = 0;
            
            if (Direction[currentStimDirection] == INCREASING) {
                gotReversal(currentStimDirection);
                // 更新最后一条记录，标记为反转点
                if (trialRecords.length > 0) {
                    trialRecords[trialRecords.length-1].isReversal = true;
                }
            }
            
            changeLevel(DECREASING, currentStimDirection); // Increase difficulty
        }
    } else { // Incorrect answer
        logDebug("Incorrect answer");
        document.getElementById('smile').src = "Media/nosmiley.png";
        document.getElementById('text1').value = "Incorrect!";
        CorrectResponses[currentStimDirection] = 0;
        
        if (Direction[currentStimDirection] == DECREASING) {
            gotReversal(currentStimDirection);
            // 更新最后一条记录，标记为反转点
            if (trialRecords.length > 0) {
                trialRecords[trialRecords.length-1].isReversal = true;
            }
        }
        
        changeLevel(INCREASING, currentStimDirection); // Decrease difficulty
    }
    
    // Delay before continuing to next iteration
    setTimeout(function() {
        document.getElementById("smile").src = 'Media/null.gif';
        resetPage();
    }, 1500);
}

// Change difficulty level
function changeLevel(whichWay, dirIndex) {
    var oldLevel = currentLevel[dirIndex];
    
    if (whichWay == DECREASING) { // Increase difficulty (smaller difference)
        if (currentLevel[dirIndex] < 9) // Maximum difficulty is 9
            currentLevel[dirIndex]++;
    } else { // Decrease difficulty (larger difference)
        if (currentLevel[dirIndex] > LOWERLIMIT)
            currentLevel[dirIndex]--;
    }
    
    logDebug("Difficulty changed from " + oldLevel + " to " + currentLevel[dirIndex] + 
             (whichWay == DECREASING ? " (increasing difficulty)" : " (decreasing difficulty)"));
}

// Get threshold assessment
function getThresholdAssessment(value) {
    if (value <= 0.05) return "Exceptional";
    if (value <= 0.1) return "Excellent";
    if (value <= 0.25) return "Good";
    if (value <= 0.5) return "Average";
    if (value <= 1.0) return "Below Average";
    return "Needs Improvement";
}

// 新增：计算反应时间统计
function calculateReactionTimeStats() {
    let higherRTs = trialRecords.filter(t => t.direction === "Higher").map(t => parseFloat(t.reactionTime));
    let lowerRTs = trialRecords.filter(t => t.direction === "Lower").map(t => parseFloat(t.reactionTime));
    let allRTs = higherRTs.concat(lowerRTs);
    
    return {
        higher: {
            mean: higherRTs.length ? (higherRTs.reduce((a, b) => a + b, 0) / higherRTs.length).toFixed(0) : "N/A",
            median: higherRTs.length ? calculateMedian(higherRTs).toFixed(0) : "N/A",
            sd: higherRTs.length > 1 ? calculateSD(higherRTs).toFixed(0) : "N/A"
        },
        lower: {
            mean: lowerRTs.length ? (lowerRTs.reduce((a, b) => a + b, 0) / lowerRTs.length).toFixed(0) : "N/A",
            median: lowerRTs.length ? calculateMedian(lowerRTs).toFixed(0) : "N/A",
            sd: lowerRTs.length > 1 ? calculateSD(lowerRTs).toFixed(0) : "N/A"
        },
        overall: {
            mean: allRTs.length ? (allRTs.reduce((a, b) => a + b, 0) / allRTs.length).toFixed(0) : "N/A",
            median: allRTs.length ? calculateMedian(allRTs).toFixed(0) : "N/A",
            sd: allRTs.length > 1 ? calculateSD(allRTs).toFixed(0) : "N/A"
        }
    };
}

// 新增：计算正确率统计
function calculateAccuracyStats() {
    let higherTrials = trialRecords.filter(t => t.direction === "Higher");
    let lowerTrials = trialRecords.filter(t => t.direction === "Lower");
    let allTrials = trialRecords;
    
    return {
        higher: {
            correct: higherTrials.filter(t => t.isCorrect).length,
            total: higherTrials.length,
            percentage: higherTrials.length ? 
                (higherTrials.filter(t => t.isCorrect).length / higherTrials.length * 100).toFixed(1) : "N/A"
        },
        lower: {
            correct: lowerTrials.filter(t => t.isCorrect).length,
            total: lowerTrials.length,
            percentage: lowerTrials.length ? 
                (lowerTrials.filter(t => t.isCorrect).length / lowerTrials.length * 100).toFixed(1) : "N/A"
        },
        overall: {
            correct: allTrials.filter(t => t.isCorrect).length,
            total: allTrials.length,
            percentage: allTrials.length ? 
                (allTrials.filter(t => t.isCorrect).length / allTrials.length * 100).toFixed(1) : "N/A"
        }
    };
}

// 新增：辅助函数，计算中位数
function calculateMedian(values) {
    if (!values.length) return 0;
    
    const sortedValues = values.slice().sort((a, b) => a - b);
    const mid = Math.floor(sortedValues.length / 2);
    
    return sortedValues.length % 2 === 0 ? 
        (sortedValues[mid - 1] + sortedValues[mid]) / 2 : 
        sortedValues[mid];
}

// 新增：辅助函数，计算标准差
function calculateSD(values) {
    if (values.length <= 1) return 0;
    
    const mean = values.reduce((a, b) => a + b, 0) / values.length;
    const variance = values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / (values.length - 1);
    
    return Math.sqrt(variance);
}

// Display embedded results
function displayResults() {
    logDebug("Displaying results");
    
    // Check if we have enough data for both directions
    let hasHigherData = NumberOfReversals[0] >= MINIMUMREVERSALS;
    let hasLowerData = NumberOfReversals[1] >= MINIMUMREVERSALS;
    
    if (!hasHigherData || !hasLowerData) {
        let message = "Warning: ";
        if (!hasHigherData) message += "Higher direction has insufficient data. ";
        if (!hasLowerData) message += "Lower direction has insufficient data. ";
        message += "Results may not be reliable.";
        
        if (confirm(message + "\n\nWould you like to retry the experiment?")) {
            // Reset and restart
            window_onload();
            return;
        }
    }
    
    // Hide experiment container, show results container
    document.getElementById('experimentContainer').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'block';
    
    // Populate results table
    var tableBody = document.getElementById('resultTableBody');
    tableBody.innerHTML = '';
    
    // Add higher direction results
    var higherRow = document.createElement('tr');
    higherRow.innerHTML = 
        '<td>Higher Direction</td>' +
        '<td>' + (hasHigherData ? sentAverage[0].toFixed(4) : 'Insufficient data') + '</td>' +
        '<td>' + (hasHigherData ? sentStdev[0].toFixed(4) : '-') + '</td>' +
        '<td>' + (hasHigherData ? getThresholdAssessment(sentAverage[0]) : '-') + '</td>';
    tableBody.appendChild(higherRow);
    
    // Add lower direction results
    var lowerRow = document.createElement('tr');
    lowerRow.innerHTML = 
        '<td>Lower Direction</td>' +
        '<td>' + (hasLowerData ? sentAverage[1].toFixed(4) : 'Insufficient data') + '</td>' +
        '<td>' + (hasLowerData ? sentStdev[1].toFixed(4) : '-') + '</td>' +
        '<td>' + (hasLowerData ? getThresholdAssessment(sentAverage[1]) : '-') + '</td>';
    tableBody.appendChild(lowerRow);
    
    // Add average results if we have data for both directions
    if (hasHigherData && hasLowerData) {
        var avgThreshold = (sentAverage[0] + sentAverage[1]) / 2;
        
        // 计算平均值的标准差（使用合并方差公式）
        var combinedVariance = (Math.pow(sentStdev[0], 2) + Math.pow(sentStdev[1], 2)) / 2;
        var combinedSD = Math.sqrt(combinedVariance).toFixed(4);
        
        var avgRow = document.createElement('tr');
        avgRow.style.fontWeight = 'bold';
        avgRow.innerHTML = 
            '<td>Average</td>' +
            '<td>' + avgThreshold.toFixed(4) + '</td>' +
            '<td>' + combinedSD + '</td>' +  // 添加合并标准差
            '<td>' + getThresholdAssessment(avgThreshold) + '</td>';
        tableBody.appendChild(avgRow);
    }
    
    // Populate result interpretation
    var interpretation = document.getElementById('resultInterpretation');
    let interpretationHtml = '<p><strong>Threshold Interpretation:</strong></p>';
    
    if (hasHigherData && hasLowerData) {
        const avgThreshold = (sentAverage[0] + sentAverage[1]) / 2;
        interpretationHtml += '<p>Your average pitch discrimination threshold is ' + avgThreshold.toFixed(4) + ' semitones, indicating ' + 
            getThresholdAssessment(avgThreshold) + ' pitch discrimination ability.</p>';
    } else {
        interpretationHtml += '<p><strong>Note:</strong> Complete results not available due to insufficient data.</p>';
        
        if (hasHigherData) {
            interpretationHtml += '<p>Your higher direction threshold is ' + sentAverage[0].toFixed(4) + 
                ' semitones, indicating ' + getThresholdAssessment(sentAverage[0]) + ' discrimination ability for higher pitches.</p>';
        }
        
        if (hasLowerData) {
            interpretationHtml += '<p>Your lower direction threshold is ' + sentAverage[1].toFixed(4) + 
                ' semitones, indicating ' + getThresholdAssessment(sentAverage[1]) + ' discrimination ability for lower pitches.</p>';
        }
    }
    
    // 新增：添加反应时间和正确率信息
    interpretationHtml += '<p><strong>Performance Metrics:</strong></p>';
    
    // 计算反应时间和正确率统计
    const rtStats = calculateReactionTimeStats();
    const accuracyStats = calculateAccuracyStats();
    
    interpretationHtml += '<p>Your average reaction time was ' + rtStats.overall.mean + 
        ' ms, with ' + accuracyStats.overall.percentage + '% overall accuracy.</p>';
    
    interpretation.innerHTML = interpretationHtml;
    
    // 新增：填充反应时间统计表格
    var rtTableBody = document.getElementById('rtStatsTableBody');
    rtTableBody.innerHTML = '';
    
    var higherRtRow = document.createElement('tr');
    higherRtRow.innerHTML = 
        '<td>Higher Direction</td>' +
        '<td>' + rtStats.higher.mean + '</td>' +
        '<td>' + rtStats.higher.median + '</td>' +
        '<td>' + rtStats.higher.sd + '</td>';
    rtTableBody.appendChild(higherRtRow);
    
    var lowerRtRow = document.createElement('tr');
    lowerRtRow.innerHTML = 
        '<td>Lower Direction</td>' +
        '<td>' + rtStats.lower.mean + '</td>' +
        '<td>' + rtStats.lower.median + '</td>' +
        '<td>' + rtStats.lower.sd + '</td>';
    rtTableBody.appendChild(lowerRtRow);
    
    var overallRtRow = document.createElement('tr');
    overallRtRow.style.fontWeight = 'bold';
    overallRtRow.innerHTML = 
        '<td>Overall</td>' +
        '<td>' + rtStats.overall.mean + '</td>' +
        '<td>' + rtStats.overall.median + '</td>' +
        '<td>' + rtStats.overall.sd + '</td>';
    rtTableBody.appendChild(overallRtRow);
    
    // 新增：填充正确率统计表格
    var accuracyTableBody = document.getElementById('accuracyStatsTableBody');
    accuracyTableBody.innerHTML = '';
    
    var higherAccRow = document.createElement('tr');
    higherAccRow.innerHTML = 
        '<td>Higher Direction</td>' +
        '<td>' + accuracyStats.higher.correct + '</td>' +
        '<td>' + accuracyStats.higher.total + '</td>' +
        '<td>' + accuracyStats.higher.percentage + '%</td>';
    accuracyTableBody.appendChild(higherAccRow);
    
    var lowerAccRow = document.createElement('tr');
    lowerAccRow.innerHTML = 
        '<td>Lower Direction</td>' +
        '<td>' + accuracyStats.lower.correct + '</td>' +
        '<td>' + accuracyStats.lower.total + '</td>' +
        '<td>' + accuracyStats.lower.percentage + '%</td>';
    accuracyTableBody.appendChild(lowerAccRow);
    
    var overallAccRow = document.createElement('tr');
    overallAccRow.style.fontWeight = 'bold';
    overallAccRow.innerHTML = 
        '<td>Overall</td>' +
        '<td>' + accuracyStats.overall.correct + '</td>' +
        '<td>' + accuracyStats.overall.total + '</td>' +
        '<td>' + accuracyStats.overall.percentage + '%</td>';
    accuracyTableBody.appendChild(overallAccRow);
    
    // Simple chart display
    drawResultChart(hasHigherData, hasLowerData);
}

// Draw result chart
function drawResultChart(hasHigherData, hasLowerData) {
    var chartContainer = document.getElementById('resultChart');
    
    // Create simple bar chart
    var chartHTML = '<div style="display: flex; flex-direction: column; height: 100%;">';
    chartHTML += '<div style="text-align: center; margin-bottom: 10px;"><strong>Threshold Comparison</strong></div>';
    
    // Chart title and legend
    chartHTML += '<div style="display: flex; justify-content: center; margin-bottom: 10px;">';
    chartHTML += '<span style="margin-right: 20px;"><span style="display: inline-block; width: 15px; height: 15px; background-color: #3498db; margin-right: 5px;"></span>Higher Direction</span>';
    chartHTML += '<span><span style="display: inline-block; width: 15px; height: 15px; background-color: #e74c3c; margin-right: 5px;"></span>Lower Direction</span>';
    chartHTML += '</div>';
    
    // Chart content area
    chartHTML += '<div style="flex: 1; display: flex; align-items: flex-end; border-left: 1px solid #333; border-bottom: 1px solid #333; position: relative;">';
    
    // Determine max value for chart scaling
    let maxValue = 0.5; // Default min height
    if (hasHigherData) maxValue = Math.max(maxValue, sentAverage[0]);
    if (hasLowerData) maxValue = Math.max(maxValue, sentAverage[1]);
    
    // Higher direction bar
    if (hasHigherData) {
        var higherHeight = (sentAverage[0] / maxValue) * 80; // Max height 80%
        chartHTML += '<div style="width: 40px; height: ' + higherHeight + '%; background-color: #3498db; margin: 0 20px; position: relative;">';
        chartHTML += '<div style="position: absolute; top: -20px; width: 100%; text-align: center;">' + sentAverage[0].toFixed(4) + '</div>';
        chartHTML += '</div>';
    } else {
        chartHTML += '<div style="width: 40px; height: 5%; background-color: #ccc; margin: 0 20px; position: relative;">';
        chartHTML += '<div style="position: absolute; top: -20px; width: 100%; text-align: center;">N/A</div>';
        chartHTML += '</div>';
    }
    
    // Lower direction bar
    if (hasLowerData) {
        var lowerHeight = (sentAverage[1] / maxValue) * 80;
        chartHTML += '<div style="width: 40px; height: ' + lowerHeight + '%; background-color: #e74c3c; margin: 0 20px; position: relative;">';
        chartHTML += '<div style="position: absolute; top: -20px; width: 100%; text-align: center;">' + sentAverage[1].toFixed(4) + '</div>';
        chartHTML += '</div>';
    } else {
        chartHTML += '<div style="width: 40px; height: 5%; background-color: #ccc; margin: 0 20px; position: relative;">';
        chartHTML += '<div style="position: absolute; top: -20px; width: 100%; text-align: center;">N/A</div>';
        chartHTML += '</div>';
    }
    
    // X-axis labels
    chartHTML += '<div style="position: absolute; bottom: -25px; left: 20px; width: 40px; text-align: center;">Higher</div>';
    chartHTML += '<div style="position: absolute; bottom: -25px; left: 80px; width: 40px; text-align: center;">Lower</div>';
    
    // Y-axis
    chartHTML += '<div style="position: absolute; left: -35px; top: 20%; transform: rotate(-90deg);">Threshold (semitones)</div>';
    
    chartHTML += '</div>'; // Close chart content area
    chartHTML += '</div>'; // Close entire chart container
    
    // Set HTML
    chartContainer.innerHTML = chartHTML;
}

// Return to experiment page
function backToExperiment() {
    document.getElementById('experimentContainer').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';
}

// View results button click event
function view_onclick() {
    logDebug("View results button clicked");
    
    // Calculate any incomplete directions with sufficient data
    for (let i = 0; i < 2; i++) {
        if (!isTestComplete[i] && NumberOfReversals[i] >= MINIMUMREVERSALS) {
            calculateResults(i);
            isTestComplete[i] = true;
        }
    }
    
    displayResults();
}

// 新增：导出数据到CSV文件
function exportToCSV() {
    // 准备CSV标题行
    const headers = [
        "Trial Number", 
        "Timestamp", 
        "Direction", 
        "Difficulty Level", 
        "Semitone Value", 
        "User Response", 
        "Correct Response", 
        "Is Correct", 
        "Reaction Time (ms)", 
        "Is Reversal",
        "Step Direction"
    ];
    
    // 转换数据为CSV格式
    const csvRows = [];
    csvRows.push(headers.join(","));
    
    trialRecords.forEach(function(trial) {
        const row = [
            trial.trialNumber,
            trial.timestamp,
            trial.direction,
            trial.difficultyLevel,
            trial.semitoneValue,
            trial.userResponse,
            trial.correctResponse,
            trial.isCorrect ? "1" : "0",
            trial.reactionTime,
            trial.isReversal ? "1" : "0",
            trial.stepDirection
        ];
        csvRows.push(row.join(","));
    });
    
    // 添加结果汇总
    csvRows.push("\nRESULTS SUMMARY");
    
    // 阈值结果
    csvRows.push("\nThreshold Results (semitones)");
    csvRows.push("Direction,Threshold,Standard Deviation,Assessment");
    
    // 检查数据是否有效
    const hasHigherData = NumberOfReversals[0] >= MINIMUMREVERSALS;
    const hasLowerData = NumberOfReversals[1] >= MINIMUMREVERSALS;
    
    csvRows.push("Higher," + 
        (hasHigherData ? sentAverage[0].toFixed(4) : "Insufficient data") + "," + 
        (hasHigherData ? sentStdev[0].toFixed(4) : "N/A") + "," + 
        (hasHigherData ? getThresholdAssessment(sentAverage[0]) : "N/A"));
    
    csvRows.push("Lower," + 
        (hasLowerData ? sentAverage[1].toFixed(4) : "Insufficient data") + "," + 
        (hasLowerData ? sentStdev[1].toFixed(4) : "N/A") + "," + 
        (hasLowerData ? getThresholdAssessment(sentAverage[1]) : "N/A"));
    
    if (hasHigherData && hasLowerData) {
        const avgThreshold = (sentAverage[0] + sentAverage[1]) / 2;
        // 计算平均值的标准差
        const combinedVariance = (Math.pow(sentStdev[0], 2) + Math.pow(sentStdev[1], 2)) / 2;
        const combinedSD = Math.sqrt(combinedVariance).toFixed(4);
        
        csvRows.push("Average," + avgThreshold.toFixed(4) + "," + combinedSD + "," + getThresholdAssessment(avgThreshold));
    }
    
    // 反应时间统计
    const rtStats = calculateReactionTimeStats();
    csvRows.push("\nReaction Time Statistics (ms)");
    csvRows.push("Direction,Mean,Median,Standard Deviation");
    csvRows.push("Higher," + rtStats.higher.mean + "," + rtStats.higher.median + "," + rtStats.higher.sd);
    csvRows.push("Lower," + rtStats.lower.mean + "," + rtStats.lower.median + "," + rtStats.lower.sd);
    csvRows.push("Overall," + rtStats.overall.mean + "," + rtStats.overall.median + "," + rtStats.overall.sd);
    
    // 正确率统计
    const accuracyStats = calculateAccuracyStats();
    csvRows.push("\nAccuracy Statistics");
    csvRows.push("Direction,Correct Responses,Total Responses,Percentage");
    csvRows.push("Higher," + accuracyStats.higher.correct + "," + accuracyStats.higher.total + "," + accuracyStats.higher.percentage + "%");
    csvRows.push("Lower," + accuracyStats.lower.correct + "," + accuracyStats.lower.total + "," + accuracyStats.lower.percentage + "%");
    csvRows.push("Overall," + accuracyStats.overall.correct + "," + accuracyStats.overall.total + "," + accuracyStats.overall.percentage + "%");
    
    // 实验参数
    csvRows.push("\nExperiment Parameters");
    csvRows.push("Max Reversals," + MAXREVERSALS);
    csvRows.push("Min Reversals for Calculation," + MINIMUMREVERSALS);
    csvRows.push("Max Iterations," + MAXITERATIONS);
    
    // 生成CSV内容
    const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
    
    // 创建下载链接
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "pitch_discrimination_data_" + timestamp + ".csv");
    document.body.appendChild(link);
    
    // 触发下载
    link.click();
    
    // 清理
    document.body.removeChild(link);
}

// Page initialization
function window_onload() {
    window.name = "EXP";
    NumberOfReversals = [0, 0];
    numberOfIterations = 0;
    CorrectResponses = [0, 0];
    Direction = [DECREASING, DECREASING];
    currentLevel = [5, 5]; // Start at medium difficulty 5
    isTestComplete = [false, false];
    Reversals = [[], []];
    trialsPerDirection = [0, 0];
    forceDirection = null;
    directionHistory = [];
    // 新增：重置试验记录数组
    trialRecords = [];
    
    document.getElementById('text1').value = "Click 'Start Experiment' to begin the test";
    document.getElementById('smile').src = "Media/null.gif";
    document.getElementById('start').disabled = false;
    document.getElementById('viewResult').disabled = true;
    document.getElementById('promptText').style.visibility = 'hidden';
    
    // Ensure initial state is experiment interface
    document.getElementById('experimentContainer').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';
    
    // 重置进度条
    updateProgressBar(0);
    
    logDebug("Page reset complete");
}

// Initialize page
window.onload = function() {
    window_onload();
    
    // Preload all audio
    var allAudios = document.querySelectorAll('audio');
    logDebug("Preloading " + allAudios.length + " audio files");
    
    allAudios.forEach(function(audio) {
        audio.load();
    });
    
    document.getElementById('text1').value = "Ready. Click 'Start Experiment' to begin";
    
    // Add error handler to catch global errors
    window.onerror = function(message, source, lineno, colno, error) {
        logDebug("Global error: " + message + " at " + source + ":" + lineno);
        return false;
    };
    
    // Show debug info by default
    document.getElementById('showDebug').checked = true;
    toggleDebug();
};
</script>
</body>
</html>